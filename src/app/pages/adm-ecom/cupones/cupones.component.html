<div class="card">
    <p-toast></p-toast>

    <p-tabs [value]="activeTabIndex.toString()">
        <p-tablist>
            <p-tab value="0">
                <i class="pi pi-tags mr-2"></i>
                Cupones
            </p-tab>
            <p-tab value="1">
                <span class="flex items-center gap-2">
                    <i class="pi pi-users"></i>
                    Clientes
                    <p-tag *ngIf="cuponSeleccionado" [value]="cuponSeleccionado.codigo" severity="info"
                        class="text-xs ml-2">
                    </p-tag>
                </span>
            </p-tab>
        </p-tablist>

        <p-tabpanels>
            <!-- TAB CUPONES -->
            <p-tabpanel value="0">

                <p-table #dtCupon [value]="filteredCupones" [loading]="loadingCupones" [paginator]="true" [rows]="10"
                    [showCurrentPageReport]="true" responsiveLayout="scroll"
                    currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} registros"
                    [rowsPerPageOptions]="[10,25,50]" [globalFilterFields]="[
                        'id_cupon',
                        'codigo',
                        'descripcion',
                        'id_promo',
                        'limite',
                        'importe_minimo',
                        'estado',
                        'total_activados',
                        'total_aplicado'
                    ]" selectionMode="single" [(selection)]="cuponSeleccionado" (onRowSelect)="onCuponSelect($event)">

                    <!-- Caption con controles -->
                    <ng-template #caption>
                        <div class="flex flex-wrap gap-2 items-center justify-between">
                            <div class="flex items-center gap-2">
                                <input pInputText type="text" (input)="onGlobalFilter(dtCupon, $event)"
                                    placeholder="Buscar cupón..." class="w-full sm:w-80" />
                            </div>
                            <div class="flex gap-1 items-center">
                                <!-- Botones de filtro por estado -->
                                <div class="flex gap-1 mr-4">
                                    <button *ngFor="let estado of estadoOptions"
                                        (click)="onEstadoFiltroClick(estado.value)" pButton raised
                                        [class]="estadoFiltroSeleccionado === estado.value ? 'p-button-success compact-filter-button' : 'p-button-outlined compact-filter-button'"
                                        [label]="estado.label" pTooltip="Filtrar por {{ estado.label }}"></button>
                                </div>
                                <div class="flex gap-1">
                                    <!-- Botones de acción -->
                                    <button (click)="loadCupones()" pButton raised icon="pi pi-refresh"
                                        [loading]="loadingCupones" pTooltip="Actualizar"
                                        class="p-button-outlined order-0 sm:order-1"></button>
                                    <button (click)="openCuponForm()" pButton raised icon="pi pi-plus"
                                        pTooltip="Agregar cupón" class="order-0 sm:order-1"></button>
                                </div>
                            </div>
                        </div>
                    </ng-template>
                    <!-- HEADER -->
                    <ng-template #header>
                        <tr>
                            <th pSortableColumn="id_cupon"><span class="th-content">Id <p-sortIcon field="id"></p-sortIcon></span></th>
                            <th pSortableColumn="codigo"><span class="th-content">Código <p-sortIcon field="codigo"></p-sortIcon></span></th>
                            <th pSortableColumn="descripcion"><span class="th-content">Descripción <p-sortIcon field="descripcion"></p-sortIcon></span></th>
                            <th pSortableColumn="total_activados"><span class="th-content">Activados <p-sortIcon field="total_activados"></p-sortIcon></span></th>
                            <th pSortableColumn="total_aplicado"><span class="th-content">Aplicados <p-sortIcon field="total_aplicado"></p-sortIcon></span></th>
                            <!--<th pSortableColumn="id_promo">Id promo <p-sortIcon field="id_promo"></p-sortIcon></th>-->
                            <th pSortableColumn="limite"><span class="th-content">Límite <p-sortIcon field="limite"></p-sortIcon></span></th>
                            <th pSortableColumn="importe_minimo"><span class="th-content">Importe mínimo <p-sortIcon field="importe_minimo"></p-sortIcon></span></th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </ng-template>

                    <!-- BODY -->
                    <!--(dblclick)="onCuponDoubleClick(cupon)"-->
                    <ng-template #body let-cupon>
                        <tr [class.bg-blue-50]="cupon === cuponSeleccionado"
                            [class.collection-inactive]="cupon.estado === 'B'"
                            class="cursor-pointer hover:bg-gray-50 transition-colors"
                            (click)="onCuponSelect({ data: cupon })">
                            <td>{{ cupon.id_cupon }}</td>
                            <td>{{ cupon.codigo }}</td>
                            <td>
                                <span *ngIf="editingCell !== cupon.id_cupon + '_descripcion'"
                                    (click)="editInlineCupon(cupon, 'descripcion'); $event.stopPropagation()"
                                    class="editable-cell cursor-pointer hover:bg-blue-50 px-2 py-1 rounded transition-colors"
                                    title="Clic para editar">
                                    {{ cupon.descripcion }}
                                </span>
                                <div *ngIf="editingCell === cupon.id_cupon + '_descripcion'"
                                    class="inline-edit-container" #inlineContainer>
                                    <input pInputText type="text" maxlength="150" [(ngModel)]="cupon.descripcion"
                                        (keyup.enter)="saveInlineCupon(cupon, 'descripcion')"
                                        (keyup.escape)="cancelInlineEdit()" class="p-inputtext-sm flex-1" #input
                                        (focus)="input.select()" autofocus placeholder="Descripción del cupón" />
                                    <button pButton icon="pi pi-check" (click)="saveInlineCupon(cupon, 'descripcion')"
                                        [disabled]="isInlineSaveDisabled(cupon.descripcion)"
                                        class="p-button-sm p-button-success p-button-text inline-action-btn"
                                        pTooltip="Guardar"></button>
                                    <button pButton icon="pi pi-undo" (click)="cancelInlineEdit()"
                                        class="p-button-sm p-button-secondary p-button-text inline-action-btn"
                                        pTooltip="Deshacer"></button>
                                </div>
                            </td>
                            <td>{{ cupon.total_activados }}</td>
                            <td>{{ cupon.total_aplicado }}</td>
                            <!--<td>
                                <span *ngIf="editingCell !== cupon.id_cupon + '_id_promo'"
                                    (click)="editInlineCupon(cupon, 'id_promo'); $event.stopPropagation()"
                                    class="editable-cell cursor-pointer hover:bg-blue-50 px-2 py-1 rounded transition-colors"
                                    title="Clic para editar">
                                    {{ cupon.id_promo }}
                                </span>
                                <div *ngIf="editingCell === cupon.id_cupon + '_id_promo'" class="inline-edit-container">
                                    <input pInputText type="number" [(ngModel)]="cupon.id_promo"
                                        (keyup.enter)="saveInlineCupon(cupon, 'id_promo')"
                                        (keyup.escape)="cancelInlineEdit()" class="p-inputtext-sm flex-1" #input
                                        (focus)="input.select()" autofocus placeholder="id_promo del cupón" />
                                    <button pButton icon="pi pi-check" (click)="saveInlineCupon(cupon, 'id_promo')"
                                        [disabled]="isInlineSaveDisabled(cupon.id_promo)"
                                        class="p-button-sm p-button-success p-button-text inline-action-btn"
                                        pTooltip="Guardar"></button>
                                    <button pButton icon="pi pi-undo" (click)="cancelInlineEdit()"
                                        class="p-button-sm p-button-secondary p-button-text inline-action-btn"
                                        pTooltip="Deshacer"></button>
                                </div>
                            </td>-->
                            <td>
                                <span *ngIf="editingCell !== cupon.id_cupon + '_limite'"
                                    (click)="editInlineCupon(cupon, 'limite'); $event.stopPropagation()"
                                    class="editable-cell cursor-pointer hover:bg-blue-50 px-2 py-1 rounded transition-colors"
                                    title="Clic para editar">
                                    {{ cupon.limite }}
                                </span>
                                <div *ngIf="editingCell === cupon.id_cupon + '_limite'" class="inline-edit-container" #inlineContainer>
                                    <input pInputText type="number" [(ngModel)]="cupon.limite" [min]="1"
                                        (keyup.enter)="saveInlineCupon(cupon, 'limite')"
                                        (keyup.escape)="cancelInlineEdit()" class="p-inputtext-sm flex-1" #input
                                        (focus)="input.select()" autofocus placeholder="limite del cupón" />
                                    <button pButton icon="pi pi-check" (click)="saveInlineCupon(cupon, 'limite')"
                                        [disabled]="isInlineSaveDisabled(cupon.limite)"
                                        class="p-button-sm p-button-success p-button-text inline-action-btn"
                                        pTooltip="Guardar"></button>
                                    <button pButton icon="pi pi-undo" (click)="cancelInlineEdit()"
                                        class="p-button-sm p-button-secondary p-button-text inline-action-btn"
                                        pTooltip="Deshacer"></button>
                                </div>
                            </td>
                            <td>
                                <span *ngIf="editingCell !== cupon.id_cupon + '_importe_minimo'"
                                    (click)="editInlineCupon(cupon, 'importe_minimo'); $event.stopPropagation()"
                                    class="editable-cell cursor-pointer hover:bg-blue-50 px-2 py-1 rounded transition-colors"
                                    title="Clic para editar">
                                    {{ cupon.importe_minimo }}
                                </span>
                                <div *ngIf="editingCell === cupon.id_cupon + '_importe_minimo'"
                                    class="inline-edit-container" #inlineContainer>
                                    <input pInputText type="number" [(ngModel)]="cupon.importe_minimo" [min]="1"
                                        (keyup.enter)="saveInlineCupon(cupon, 'importe_minimo')"
                                        (keyup.escape)="cancelInlineEdit()" class="p-inputtext-sm flex-1" #input
                                        (focus)="input.select()" autofocus placeholder="Importe mínimo del cupón" />
                                    <button pButton icon="pi pi-check" (click)="saveInlineCupon(cupon, 'importe_minimo')"
                                        [disabled]="isInlineSaveDisabled(cupon.importe_minimo)"
                                        class="p-button-sm p-button-success p-button-text inline-action-btn"
                                        pTooltip="Guardar"></button>
                                    <button pButton icon="pi pi-undo" (click)="cancelInlineEdit()"
                                        class="p-button-sm p-button-secondary p-button-text inline-action-btn"
                                        pTooltip="Deshacer"></button>
                                </div>
                            </td>
                            <!--<td>{{ cupon.estado }}</td>-->
                            <!-- Estado - TOGGLE -->
                            <td>
                                <p-tag [value]="getEstadoLabel(cupon.estado)"
                                    [severity]="getEstadoSeverity(cupon.estado)"
                                    (click)="toggleEstado(cupon); $event.stopPropagation()"
                                    class="cursor-pointer hover:opacity-80 transition-opacity"
                                    title="Clic para cambiar"></p-tag>
                            </td>
                            <!-- Acciones -->
                            <td (click)="$event.stopPropagation()">
                                <div class="flex gap-1">
                                    <!-- <button pButton icon="pi pi-eye" (click)="openCuponForm(cupon)"
                                        class="p-button-sm p-button-text p-button-warning" pTooltip="Ver cupón"></button>-->
                                    <button pButton icon="pi pi-pencil" (click)="openCuponForm(cupon)"
                                        class="p-button-sm p-button-text p-button-warning"
                                        pTooltip="Ver o editar cupón"></button>
                                    <button *ngIf="cupon.estado === 'A'" pButton icon="pi pi-trash"
                                        (click)="eliminarCupon(cupon); $event.stopPropagation()"
                                        class="p-button-sm p-button-text p-button-danger"
                                        pTooltip="Eliminar cupón"></button>
                                </div>
                            </td>
                        </tr>
                    </ng-template>

                    <!-- EMPTY -->
                    <ng-template #emptymessage>
                        <tr>
                            <td colspan="10" class="text-center text-gray-400 py-6">
                                No hay cupones para mostrar
                            </td>
                        </tr>
                    </ng-template>

                </p-table>

            </p-tabpanel>

            <!-- ================= TAB CLIENTES ================= -->
            <p-tabpanel value="1">
                <div class="mb-2 text-sm text-gray-600">
                    Cupón seleccionado:
                    <strong>{{ cuponSeleccionado?.codigo || 'Ninguno' }}</strong>
                </div>

                <p-table #dtClientes [value]="filteredCuponClientes" [loading]="loadingCupond" [paginator]="true"
                    [rows]="10" [showCurrentPageReport]="true" responsiveLayout="scroll"
                    currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} registros"
                    [rowsPerPageOptions]="[10,25,50]" [globalFilterFields]="[
                        'id_cliente',
                        'NOMBRE',
                        'AP_PATERNO',
                        'AP_MATERNO',
                        'estado',
                        'fecha',
                        'id_orden',
                        'estado_orden'
                    ]">
                    <ng-template #caption>
                        <div class="flex flex-wrap gap-2 items-center justify-between">
                            <input pInputText type="text" (input)="onGlobalFilter(dtClientes, $event)"
                                placeholder="Buscar clientes..." class="w-full sm:w-80" />
                            <div class="flex gap-1">
                                <p-button icon="pi pi-refresh" (onClick)="refreshCupondData()" [loading]="loadingCupond"
                                    styleClass="p-button-sm p-button-primary p-button-raised" pTooltip="Recargar datos"
                                    tooltipPosition="top" tooltipStyleClass="custom-tooltip"></p-button>
                            </div>
                        </div>
                    </ng-template>
                    <ng-template #header>
                        <tr>
                            <th pSortableColumn="id_cliente">Id cliente <p-sortIcon field="id_cliente"></p-sortIcon>
                            </th>
                            <th pSortableColumn="NOMBRE">Nombre <p-sortIcon field="NOMBRE"></p-sortIcon></th>
                            <th pSortableColumn="estado">Estado <p-sortIcon field="estado"></p-sortIcon></th>
                            <th pSortableColumn="fecha">Fecha <p-sortIcon field="fecha"></p-sortIcon></th>
                            <th pSortableColumn="id_orden">Id orden <p-sortIcon field="id_orden"></p-sortIcon></th>
                            <th pSortableColumn="estado_orden">Estado de orden <p-sortIcon
                                    field="estado_orden"></p-sortIcon></th>
                        </tr>
                    </ng-template>

                    <ng-template #body let-cli>
                        <tr>
                            <td>{{ cli.id_cliente }}</td>
                            <td>{{ formatearNombreCompleto(cli.NOMBRE,cli.AP_PATERNO,cli.AP_MATERNO)}}</td>
                            <td>
                                <p-tag [value]="getEstadoLabelC(cli.estado)" [severity]="getEstadoSeverityC(cli.estado)"
                                    class="w-20"></p-tag>
                            </td>
                            <td>{{ formatDate(cli.fecha) }}</td>
                            <td>{{ cli.id_orden }}</td>
                            <td>{{ cli.estado_orden }}</td>
                        </tr>
                    </ng-template>

                    <ng-template #emptymessage>
                        <tr>
                            <td colspan="3" class="text-center">
                                No hay clientes para este cupón
                            </td>
                        </tr>
                    </ng-template>
                </p-table>
            </p-tabpanel>
        </p-tabpanels>
    </p-tabs>
</div>
<!-- Diálogo de confirmación personalizado -->
<p-dialog header="{{confirmHeader}}" [(visible)]="showConfirmDialog" [modal]="true" [style]="{width: '450px'}"
    [closable]="true" (onHide)="cancelarConfirmacion()">
    <div class="flex align-items-center gap-3 mb-3">
        <i class="pi pi-exclamation-triangle text-orange-500 text-2xl"></i>
        <span class="text-lg">{{confirmMessage}}</span>
    </div>

    <div class="flex justify-content-end gap-2 mt-4">
        <p-button label="Cancelar" icon="pi pi-times" severity="secondary" (click)="closeCuponesForm()"></p-button>
        <p-button label="Sí, Confirmar" icon="pi pi-check" severity="danger" (onClick)="confirmarAccion()"></p-button>
    </div>
</p-dialog>


<!-- Modal de formulario CRUD -->

<!-- Modal de confirmación personalizado -->
<p-dialog header="{{confirmHeader}}" [(visible)]="showConfirmDialog" [modal]="true" [style]="{width: '450px'}"
    [dismissableMask]="true" [closable]="true" (onHide)="cancelarConfirmacion()">
    <div class="flex align-items-center gap-3 mb-3">
        <i class="pi pi-exclamation-triangle text-orange-500 text-2xl"></i>
        <span class="text-lg">{{confirmMessage}}</span>
    </div>

    <div class="flex justify-content-end gap-2 mt-4">
        <p-button label="Cancelar" icon="pi pi-times" severity="secondary"
            (onClick)="cancelarConfirmacion()"></p-button>
        <p-button label="Sí, confirmar" icon="pi pi-check" severity="danger" (onClick)="confirmarAccion()"></p-button>
    </div>
</p-dialog>

<!-- Modal formulario de Cupones -->
<!--<p-dialog [(visible)]="showCuponModal" [header]="isEditingCupon ? 'Editar cupón' : 'Nuevo cupón'"
    [modal]="true" [style]="{width: '600px'}" [draggable]="false" [resizable]="false" [closable]="true"
    [closeOnEscape]="true" (onHide)="closeCuponesForm()" [baseZIndex]="1000"
    styleClass="dialog-overlay-fix">

</p-dialog>-->

<!-- Modal maqueta -->
<p-dialog [(visible)]="showCuponModal" [header]="isEditingCupon ? 'Editar cupón' : 'Nuevo cupón'" [modal]="true"
    [dismissableMask]="true" [style]="{ width: '900px', maxWidth: '95vw' }" [draggable]="false" [resizable]="false"
    [closable]="true" [closeOnEscape]="true" [(visible)]="showCuponModal" (onHide)="onCuponModalHide()">
    <form [formGroup]="CuponesForm" (ngSubmit)="saveCupon()">

        <div class="p-6">

            <!-- Campos -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">

                <!-- Código -->
                <div class="text-sm font-medium mb-1 col-span-1">
                    <label>Código</label>
                    <input pInputText class="w-full" formControlName="codigo" />
                    <small *ngIf="CuponesForm.get('codigo')?.invalid && CuponesForm.get('codigo')?.touched"
                        class="text-red-500">
                        El código es obligatorio
                    </small>
                </div>

                <!-- ID Promo< -->
                <div class="text-sm font-medium mb-1 col-span-1">
                    <label>ID Promo</label>
                    <input pInputText type="number" class="w-full" formControlName="id_promo" />
                    <small *ngIf="CuponesForm.get('id_promo')?.invalid && CuponesForm.get('id_promo')?.touched"
                        class="text-red-500">
                        ID promo es obligatorio
                    </small>
                </div>

                <!-- Tipo cupón -->
                <div class="text-sm font-medium mb-1 col-span-1">
                    <label>Tipo cupón</label>
                    <input pInputText type="number" class="w-full" formControlName="tipo_cupon" [min]="1" [max]="3" />
                    <small *ngIf="CuponesForm.get('tipo_cupon')?.invalid && CuponesForm.get('tipo_cupon')?.touched"
                        class="text-red-500">
                        El tipo de cupón es obligatorio
                    </small>
                </div>


                <!-- Descripción -->
                <div class="text-sm font-medium mb-1 col-span-1 md:col-span-3">
                    <label>Descripción</label>
                    <textarea pTextarea rows="3" class="w-full p-inputtextarea resize-none text-sm font-medium"
                        formControlName="descripcion" maxlength="150"></textarea>
                    <small *ngIf="CuponesForm.get('descripcion')?.invalid && CuponesForm.get('descripcion')?.touched"
                        class="text-red-500">
                        La descripción es obligatoria
                    </small>
                </div>

                <!-- Fecha inicio -->
                <div class="text-sm font-medium mb-1 col-span-1">
                    <label>Fecha inicio</label>
                    <p-datepicker [showIcon]="true" dateFormat="dd/mm/yy" styleClass="w-full"
                        (onShow)="disableModalClose = true" (onHide)="disableModalClose = false"
                        formControlName="fecha_ini"></p-datepicker>
                    <small *ngIf="CuponesForm.get('fecha_ini')?.invalid && CuponesForm.get('fecha_ini')?.touched"
                        class="text-red-500">
                        Fecha de inicio es obligatoria
                    </small>
                </div>

                <!-- Fecha fin -->
                <div class="text-sm font-medium mb-1 col-span-1">
                    <label>Fecha fin</label>
                    <p-datepicker [showIcon]="true" dateFormat="dd/mm/yy" styleClass="w-full"
                        (onShow)="disableModalClose = true" (onHide)="disableModalClose = false"
                        formControlName="fecha_fin"></p-datepicker>
                    <small *ngIf="CuponesForm.get('fecha_fin')?.invalid && CuponesForm.get('fecha_fin')?.touched"
                        class="text-red-500">
                        Fecha de fin es obligatoria
                    </small>
                </div>

                <!-- Estado -->
                <div class="text-sm font-medium mb-1 col-span-1">
                    <div class="flex flex-col">
                        <div><label>Estado</label></div>
                        <!-- <div><p-tag [value]="CuponesForm.get('estado')?.value === 'A' ? 'Activo' : 'Inactivo'"
                                [severity]="CuponesForm.get('estado')?.value === 'A' ? 'success' : 'danger'"
                                (click)="toggleState()"
                                class="cursor-pointer hover:opacity-80 transition-opacity w-20 h-12"
                                pTooltip="Presione para cambiar estado"></p-tag>
                        </div>-->
                        <!-- Estado -->
                        <div class="pt-2">
                            <p-toggleSwitch formControlName="estadoToggle" pTooltip="Inactivo/Activo"
                                class="status-toggle">
                            </p-toggleSwitch>
                        </div>
                    </div>
                </div>


                <!-- Límite -->
                <div class="text-sm font-medium mb-1 col-span-1">
                    <label>Límite</label>
                    <input pInputText type="number" class="w-full" formControlName="limite" [min]="1" />
                    <small *ngIf="CuponesForm.get('limite')?.invalid && CuponesForm.get('limite')?.touched"
                        class="text-red-500">
                        El límite es obligatorio
                    </small>
                </div>


                <!-- Importe mínimo -->
                <div class="text-sm font-medium mb-1 col-span-1">
                    <label>Importe mínimo</label>
                    <input pInputText type="number" class="w-full"  formControlName="importe_minimo"/>
                    <!--<p-inputnumber mode="decimal" class="w-full" formControlName="importe_minimo" />-->
                    <small
                        *ngIf="CuponesForm.get('importe_minimo')?.invalid && CuponesForm.get('importe_minimo')?.touched"
                        class="text-red-500">
                        El importe mínimo es obligatorio
                    </small>
                </div>

                <!-- Valor descuento -->
                <div class="text-sm font-medium mb-1 col-span-1">
                    <label>Valor descuento</label>
                    <input pInputText class="w-full" formControlName="valor_desc" />
                    <small *ngIf="CuponesForm.get('valor_desc')?.invalid && CuponesForm.get('valor_desc')?.touched"
                        class="text-red-500">
                        El valor de descuento es obligatorio
                    </small>
                </div>


                <!-- URL -->
                <div class="text-sm font-medium mb-1 col-span-1 md:col-span-3">
                    <label>URL</label>
                    <input pInputText class="w-full" formControlName="url_min" />
                </div>



            </div>

            <!-- Botones -->
            <div class="flex justify-end gap-2 pt-4 border-t border-gray-200">
                <p-button type="button" label="Cancelar" [text]="true" (click)="closeCuponesForm()"
                    class="p-button-text"></p-button>

                <p-button type="submit" [label]="isEditingCupon ? 'Actualizar' : 'Crear'"
                    [disabled]=" !CuponesForm.valid || savingCupones || (isEditingCupon && CuponesForm.pristine)"
                    class="p-button-primary"></p-button>
            </div>

        </div>
    </form>
</p-dialog>