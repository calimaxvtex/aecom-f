<div class="card">
    <p-toast></p-toast>

    <p-tabs [value]="activeTabIndex.toString()">
        <p-tablist>
            <p-tab value="0">
                <i class="pi pi-tags mr-2"></i>
                Cupones
            </p-tab>
            <p-tab value="1">
                <span class="flex items-center gap-2">
                    <i class="pi pi-users"></i>
                    Clientes
                    <p-tag
                            *ngIf="cuponSeleccionado"
                            [value]="cuponSeleccionado.codigo"
                            severity="info"
                            class="text-xs ml-2">
                    </p-tag>
                </span>
            </p-tab>
        </p-tablist>

        <p-tabpanels>
            <!-- TAB CUPONES -->
            <p-tabpanel value="0">

                <p-table
                    #dtCupon
                    [value]="filteredCupones"
                    [loading]="loadingCupones"
                    [paginator]="true"
                    [rows]="10"
                    [showCurrentPageReport]="true"
                    responsiveLayout="scroll"
                    currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} registros"
                    [rowsPerPageOptions]="[10,25,50]"
                    [globalFilterFields]="[
                        'id_cupon',
                        'codigo',
                        'descripcion',
                        'limite',
                        'importe_minimo',
                        'estado'
                    ]"
                    selectionMode="single"
                    [(selection)]="cuponSeleccionado"
                    (onRowSelect)="onCuponSelect($event)"
                    
                >

                    <!-- Caption con controles -->
                    <ng-template #caption>
                        <div class="flex flex-wrap gap-2 items-center justify-between">
                            <div class="flex items-center gap-2">
                                <input pInputText type="text" (input)="onGlobalFilter(dtCupon, $event)" placeholder="Buscar cupón..."
                                    class="w-full sm:w-80" />
                            </div>
                            <div class="flex gap-2 items-center">
                                <!-- Botones de filtro por estado
                                <div class="flex gap-1 mr-4">
                                    <button *ngFor="let estado of estadoOptions" (click)="onEstadoFiltroClick(estado.value)" pButton
                                        raised
                                        [class]="estadoFiltroSeleccionado === estado.value ? 'p-button-success compact-filter-button' : 'p-button-outlined compact-filter-button'"
                                        [label]="estado.label" pTooltip="Filtrar por {{ estado.label }}"></button>
                                </div> -->
                                <!-- Separador visual -->
                                <div class="w-px bg-gray-300 mx-2"></div>
                                <!-- Botones de acción -->
                                <button (click)="loadCupones()" pButton raised icon="pi pi-refresh" [loading]="loadingCupones"
                                    pTooltip="Actualizar" class="p-button-outlined"></button>
                                <button (click)="openCuponForm()" pButton raised icon="pi pi-plus" pTooltip="Agregar cupón"
                                    class=""></button>
                            </div>
                        </div>
                    </ng-template>
                    <!-- HEADER -->
                    <ng-template #header>
                        <tr>
                            <th pSortableColumn="id_cupon">Id <p-sortIcon field="id"></p-sortIcon></th>
                            <th pSortableColumn="codigo">Código <p-sortIcon field="codigo"></p-sortIcon></th>
                            <th pSortableColumn="descripcion">Descripción <p-sortIcon field="descripcion"></p-sortIcon></th>
                            <th pSortableColumn="limite">Límite <p-sortIcon field="limite"></p-sortIcon></th>
                            <th pSortableColumn="importe_minimo">Importe mínimo <p-sortIcon field="importe_minimo"></p-sortIcon></th>
                            <th pSortableColumn="estado">Estado <p-sortIcon field="estado"></p-sortIcon></th>
                            <th>Acciones</th>
                        </tr>
                    </ng-template>

                    <!-- BODY -->
                    <ng-template #body let-cupon>
                        <tr
                        [   class.bg-blue-50]="cupon === cuponSeleccionado"
                            [class.collection-inactive]="cupon.estado === 'B'"
                            class="cursor-pointer hover:bg-gray-50 transition-colors"
                            (click)="onCuponSelect({ data: cupon })"
                            (dblclick)="onCuponDoubleClick(cupon)"
                        >
                            <td>{{ cupon.id_cupon }}</td>
                            <td>{{ cupon.codigo }}</td>
                            <td>{{ cupon.descripcion }}</td>
                            <td>{{ cupon.limite }}</td>
                            <td>{{ cupon.importe_minimo }}</td>
                            <!--<td>{{ cupon.estado }}</td>-->
                            <!-- Estado - TOGGLE -->
                            <td>
                                <p-tag [value]="getEstadoLabel(cupon.estado)" [severity]="getEstadoSeverity(cupon.estado)"
                                (click)="toggleEstado(cupon); $event.stopPropagation()"
                                class="cursor-pointer hover:opacity-80 transition-opacity" title="Clic para cambiar"></p-tag>
                            </td>
                            <!-- Acciones -->
                            <td (click)="$event.stopPropagation()">
                                <div class="flex gap-1">
                                    <button pButton icon="pi pi-eye" (click)="openCpForm(Cp)"
                                        class="p-button-sm p-button-text p-button-warning" pTooltip="Ver cupón"></button>
                                    <button pButton icon="pi pi-pencil" (click)="openCpForm(Cp)"
                                        class="p-button-sm p-button-text p-button-warning" pTooltip="Editar cupón"></button>
                                    <button pButton icon="pi pi-trash" (click)="eliminarCupon(cupon); $event.stopPropagation()"
                                        class="p-button-sm p-button-text p-button-danger" pTooltip="Eliminar cupón"></button>
                                </div>
                            </td>
                        </tr>
                    </ng-template>

                    <!-- EMPTY -->
                    <ng-template #emptymessage>
                        <tr>
                            <td colspan="10" class="text-center text-gray-400 py-6">
                                No hay cupones para mostrar
                            </td>
                        </tr>
                    </ng-template>

                </p-table>

            </p-tabpanel>

             <!-- ================= TAB CLIENTES ================= -->
             <p-tabpanel value="1">
                <div class="mb-2 text-sm text-gray-600">
                    Cupón seleccionado:
                    <strong>{{ cuponSeleccionado?.codigo || 'Ninguno' }}</strong>
                </div>

                <p-table
                    #dtClientes
                    [value]="filteredCuponClientes"
                    [loading]="loadingCupond"
                    [paginator]="true"
                    [rows]="10"
                    [showCurrentPageReport]="true"
                    responsiveLayout="scroll"
                    currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} registros"
                    [rowsPerPageOptions]="[10,25,50]"
                    [globalFilterFields]="[
                        'id_cliente',
                        'NOMBRE',
                        'AP_PATERNO',
                        'AP_MATERNO',
                        'estado',
                        'fecha',
                        'id_orden',
                        'estado_orden'
                    ]"
                >
                    <ng-template #caption>
                        <div class="flex flex-wrap gap-2 items-center justify-between">
                            <input
                                pInputText
                                type="text"
                                (input)="onGlobalFilter(dtClientes, $event)"
                                placeholder="Buscar clientes..."
                                class="w-full sm:w-80"
                            />
                            <div class="flex gap-1">
                                <p-button
                                    icon="pi pi-refresh"
                                    (onClick)="refreshCupondData()"
                                    [loading]="loadingCupond"
                                    styleClass="p-button-sm p-button-primary p-button-raised"
                                    pTooltip="Recargar datos"
                                    tooltipPosition="top"
                                    tooltipStyleClass="custom-tooltip"
                                ></p-button>
                            </div>
                        </div>
                    </ng-template>
                    <ng-template #header>
                        <tr>
                            <th pSortableColumn="id_cliente">Id cliente <p-sortIcon field="id_cliente"></p-sortIcon></th>
                            <th pSortableColumn="NOMBRE">Nombre <p-sortIcon field="NOMBRE"></p-sortIcon></th>
                            <th pSortableColumn="estado">Estado <p-sortIcon field="estado"></p-sortIcon></th>
                            <th pSortableColumn="fecha">Fecha <p-sortIcon field="fecha"></p-sortIcon></th>
                            <th pSortableColumn="id_orden">Id orden <p-sortIcon field="id_orden"></p-sortIcon></th>
                            <th pSortableColumn="estado_orden">Estado de orden <p-sortIcon field="estado_orden"></p-sortIcon></th>
                        </tr>
                    </ng-template>

                    <ng-template #body let-cli>
                        <tr>
                            <td>{{ cli.id_cliente }}</td>
                            <td>{{ formatearNombreCompleto(cli.NOMBRE,cli.AP_PATERNO,cli.AP_MATERNO)}}</td>
                            <td>
                                <p-tag [value]="getEstadoLabelC(cli.estado)" [severity]="getEstadoSeverityC(cli.estado)"
                                title="Clic para cambiar"></p-tag>
                            </td>
                            <td>{{ formatDate(cli.fecha) }}</td>
                            <td>{{ cli.id_orden }}</td>
                            <td>{{ cli.estado_orden }}</td>
                        </tr>
                    </ng-template>

                    <ng-template #emptymessage>
                        <tr>
                            <td colspan="3" class="text-center">
                                No hay clientes para este cupón
                            </td>
                        </tr>
                    </ng-template>
                </p-table>
            </p-tabpanel>
        </p-tabpanels>
    </p-tabs>
</div>
<!-- Diálogo de confirmación personalizado -->
<p-dialog
    header="{{confirmHeader}}"
    [(visible)]="showConfirmDialog"
    [modal]="true"
    [style]="{width: '450px'}"
    [closable]="true"
    (onHide)="cancelarConfirmacion()"
>
    <div class="flex align-items-center gap-3 mb-3">
        <i class="pi pi-exclamation-triangle text-orange-500 text-2xl"></i>
        <span class="text-lg">{{confirmMessage}}</span>
    </div>

    <div class="flex justify-content-end gap-2 mt-4">
        <p-button
            label="Cancelar"
            icon="pi pi-times"
            severity="secondary"
            (onClick)="cancelarConfirmacion()"
        ></p-button>
        <p-button
            label="Sí, Confirmar"
            icon="pi pi-check"
            severity="danger"
            (onClick)="confirmarAccion()"
        ></p-button>
    </div>
</p-dialog>


<!-- Modal de formulario CRUD -->

<!-- Modal de confirmación personalizado -->
<p-dialog header="{{confirmHeader}}" [(visible)]="showConfirmDialog" [modal]="true" [style]="{width: '450px'}"
    [closable]="true" (onHide)="cancelarConfirmacion()">
    <div class="flex align-items-center gap-3 mb-3">
        <i class="pi pi-exclamation-triangle text-orange-500 text-2xl"></i>
        <span class="text-lg">{{confirmMessage}}</span>
    </div>

    <div class="flex justify-content-end gap-2 mt-4">
        <p-button label="Cancelar" icon="pi pi-times" severity="secondary"
            (onClick)="cancelarConfirmacion()"></p-button>
        <p-button label="Sí, confirmar" icon="pi pi-check" severity="danger" (onClick)="confirmarAccion()"></p-button>
    </div>
</p-dialog>

<!-- Modal formulario de Cupones -->
<!--<p-dialog [(visible)]="showCuponModal" [header]="isEditingCupon ? 'Editar cupón' : 'Nuevo cupón'"
    [modal]="true" [style]="{width: '600px'}" [draggable]="false" [resizable]="false" [closable]="true"
    [closeOnEscape]="true" (onHide)="closeCuponesForm()" [baseZIndex]="1000"
    styleClass="dialog-overlay-fix">

</p-dialog>-->

<!-- Modal maqueta -->
<p-dialog
    [(visible)]="showCuponModal"
    header="Cupón"
    [modal]="true"
    [style]="{ width: '900px', maxWidth: '95vw' }"
    [draggable]="false"
    [resizable]="false"
    styleClass="push-notification-form-dialog"
>

    <div class="p-6">

        <!-- Campos -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">

            <!-- Código -->
            <div class="col-span-1">
                <p-floatLabel variant="on">
                    <input pInputText class="w-full" />
                    <label>Código</label>
                </p-floatLabel>
            </div>

            <!-- Estado -->
            <div class="col-span-1">
                <p-floatLabel variant="on">
                    <p-select class="w-full"></p-select>
                    <label>Estado</label>
                </p-floatLabel>
            </div>

            <!-- Descripción -->
            <div class="col-span-1 md:col-span-2">
                <p-floatLabel variant="on">
                    <textarea pTextarea rows="3" class="w-full"></textarea>
                    <label>Descripción</label>
                </p-floatLabel>
            </div>

            <!-- Fecha inicio -->
            <div class="col-span-1">
                <p-floatLabel variant="on">
                    <p-datepicker
                        [showIcon]="true"
                        dateFormat="dd/mm/yy"
                        styleClass="w-full"
                    ></p-datepicker>
                    <label>Fecha inicio</label>
                </p-floatLabel>
            </div>

            <!-- Fecha fin -->
            <div class="col-span-1">
                <p-floatLabel variant="on">
                    <p-datepicker
                        [showIcon]="true"
                        dateFormat="dd/mm/yy"
                        styleClass="w-full"
                    ></p-datepicker>
                    <label>Fecha fin</label>
                </p-floatLabel>
            </div>

            <!-- ID Promo -->
            <div class="col-span-1">
                <p-floatLabel variant="on">
                    <input pInputText class="w-full" />
                    <label>ID Promo</label>
                </p-floatLabel>
            </div>

            <!-- Límite -->
            <div class="col-span-1">
                <p-floatLabel variant="on">
                    <input pInputText type="number" class="w-full" />
                    <label>Límite</label>
                </p-floatLabel>
            </div>

            <!-- Tipo cupón -->
            <div class="col-span-1">
                <p-floatLabel variant="on">
                    <p-select class="w-full"></p-select>
                    <label>Tipo cupón</label>
                </p-floatLabel>
            </div>

            <!-- Importe mínimo -->
            <div class="col-span-1">
                <p-floatLabel variant="on">
                    <input pInputText type="number" class="w-full" />
                    <label>Importe mínimo</label>
                </p-floatLabel>
            </div>

            <!-- URL mínima -->
            <div class="col-span-1 md:col-span-2">
                <p-floatLabel variant="on">
                    <input pInputText class="w-full" />
                    <label>URL mínima</label>
                </p-floatLabel>
            </div>

            <!-- Valor descuento -->
            <div class="col-span-1">
                <p-floatLabel variant="on">
                    <input pInputText type="number" class="w-full" />
                    <label>Valor descuento</label>
                </p-floatLabel>
            </div>

        </div>

        <!-- Footer -->
        <div class="flex justify-end gap-2 pt-4 border-t border-gray-200">
            <p-button
                type="button"
                label="Cancelar"
                icon="pi pi-times"
                severity="secondary"
                [text]="true"
            ></p-button>

            <p-button
                type="button"
                label="Guardar"
                icon="pi pi-save"
            ></p-button>
        </div>

    </div>
</p-dialog>
