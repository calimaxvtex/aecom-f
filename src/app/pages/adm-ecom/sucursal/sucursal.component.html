<div class="card">
    <p-toast></p-toast>

    <!-- Header con filtro por proyecto -->
    <div class="mb-4">
        <h1 class="text-2xl font-bold mb-4"> Administraci贸n de Sucursales</h1>
        <div class="flex gap-4 items-end">
            <div class="flex-1">
                <p-floatLabel variant="on">
                    <p-select
                        [(ngModel)]="proyectoSeleccionadoId"
                        [options]="proyectos"
                        [optionLabel]="getDisplayField()"
                        optionValue="id_proy"
                        placeholder="Seleccionar proyecto"
                        class="w-full"
                        (onChange)="onProyectoChange($event)"
                        [loading]="loadingProyectos"
                    ></p-select>
                    <label>Proyecto *</label>
                </p-floatLabel>
            </div>
        </div>
    </div>

    <!-- Tabla de sucursales -->
    <p-table
        #dtSucursales
        [value]="sucursales"
        [paginator]="true"
        [rows]="10"
        [showCurrentPageReport]="true"
        responsiveLayout="scroll"
        currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} sucursales"
        [rowsPerPageOptions]="[10, 25, 50]"
        [globalFilterFields]="['tienda', 'direccion']"
        dataKey="sucursal"
        [sortMode]="'multiple'"
        [filterDelay]="300"
        [loading]="loadingSucursales"
    >
        <!-- Caption con controles -->
        <ng-template #caption>
            <div class="flex flex-wrap gap-2 items-center justify-between">
                <div class="flex items-center gap-2">
                    <input
                        pInputText
                        type="text"
                        (input)="onGlobalFilter(dtSucursales, $event)"
                        placeholder="Buscar sucursales..."
                        class="w-full sm:w-80"
                    />
                </div>
                <div class="flex gap-2 items-center">
                    <!-- Botones de filtro por estado -->
                    <div class="flex gap-1 mr-4">
                        <button
                            *ngFor="let estado of estadoOptions"
                            (click)="onEstadoFiltroClick(estado.value)"
                            pButton
                            raised
                            [class]="estadoFiltroSeleccionado === estado.value ? 'p-button-success compact-filter-button' : 'p-button-outlined compact-filter-button'"
                            [label]="estado.label"
                            pTooltip="Filtrar por {{ estado.label }}"
                        ></button>
                    </div>
                    <!-- Separador visual -->
                    <div class="w-px bg-gray-300 mx-2"></div>
                    <!-- Botones de acci贸n -->
                    <button
                        (click)="cargarSucursales()"
                        pButton
                        raised
                        icon="pi pi-refresh"
                        [loading]="loadingSucursales"
                        pTooltip="Actualizar"
                    ></button>
                    <button
                        (click)="openSucursalForm()"
                        pButton
                        raised
                        icon="pi pi-plus"
                        pTooltip="Agregar Sucursal"
                        [disabled]="!proyectoSeleccionado"
                    ></button>
                </div>
            </div>
        </ng-template>

        <!-- Headers -->
        <ng-template #header>
            <tr>
                <th pSortableColumn="sucursal" style="width: 80px">ID <p-sortIcon field="sucursal"></p-sortIcon></th>
                <th pSortableColumn="tienda" style="min-width: 200px">Nombre <p-sortIcon field="tienda"></p-sortIcon></th>
                <th pSortableColumn="direccion" style="min-width: 300px">Direcci贸n <p-sortIcon field="direccion"></p-sortIcon></th>
                <th pSortableColumn="estado" style="width: 100px">Estado <p-sortIcon field="estado"></p-sortIcon></th>
                <th style="width: 150px">Acciones</th>
            </tr>
        </ng-template>

        <!-- Body -->
        <ng-template #body let-sucursal>
            <tr
                [class.bg-blue-50]="sucursal === proyectoSeleccionado"
                class="cursor-pointer hover:bg-gray-50 transition-colors"
            >
                <!-- ID -->
                <td class="text-center font-mono text-sm">{{ sucursal.sucursal }}</td>

                <!-- Nombre - EDITABLE -->
                <td>
                    <span
                        *ngIf="editingCell !== sucursal.sucursal + '_tienda'"
                        (click)="editInlineSucursal(sucursal, 'tienda'); $event.stopPropagation()"
                        class="editable-cell cursor-pointer hover:bg-blue-50 px-2 py-1 rounded transition-colors"
                        title="Clic para editar"
                    >
                        {{ sucursal.tienda | titlecase }}
                    </span>
                    <div
                        *ngIf="editingCell === sucursal.sucursal + '_tienda'"
                        class="inline-edit-container"
                    >
                        <input
                            pInputText
                            type="text"
                            [(ngModel)]="sucursal.tienda"
                            (keyup.enter)="saveInlineEditSucursal(sucursal, 'tienda')"
                            (keyup.escape)="cancelInlineEdit()"
                            class="p-inputtext-sm flex-1"
                            #input
                            (focus)="input.select()"
                            autofocus
                            placeholder="Nombre de la sucursal"
                        />
                        <button
                            pButton
                            icon="pi pi-check"
                            (click)="saveInlineEditSucursal(sucursal, 'tienda')"
                            class="p-button-sm p-button-success p-button-text inline-action-btn"
                            pTooltip="Guardar (Enter)"
                        ></button>
                        <button
                            pButton
                            icon="pi pi-undo"
                            (click)="cancelInlineEdit()"
                            class="p-button-sm p-button-secondary p-button-text inline-action-btn"
                            pTooltip="Deshacer (Escape)"
                        ></button>
                    </div>
                </td>

                <!-- Direcci贸n - EDITABLE -->
                <td>
                    <span
                        *ngIf="editingCell !== sucursal.sucursal + '_direccion'"
                        (click)="editInlineSucursal(sucursal, 'direccion'); $event.stopPropagation()"
                        class="editable-cell cursor-pointer hover:bg-blue-50 px-2 py-1 rounded transition-colors"
                        title="Clic para editar"
                    >
                        {{ sucursal.direccion | titlecase }}
                    </span>
                    <div
                        *ngIf="editingCell === sucursal.sucursal + '_direccion'"
                        class="inline-edit-container"
                    >
                        <input
                            pInputText
                            type="text"
                            [(ngModel)]="sucursal.direccion"
                            (keyup.enter)="saveInlineEditSucursal(sucursal, 'direccion')"
                            (keyup.escape)="cancelInlineEdit()"
                            class="p-inputtext-sm flex-1"
                            #input
                            (focus)="input.select()"
                            autofocus
                            placeholder="Direcci贸n de la sucursal"
                        />
                        <button
                            pButton
                            icon="pi pi-check"
                            (click)="saveInlineEditSucursal(sucursal, 'direccion')"
                            class="p-button-sm p-button-success p-button-text inline-action-btn"
                            pTooltip="Guardar (Enter)"
                        ></button>
                        <button
                            pButton
                            icon="pi pi-undo"
                            (click)="cancelInlineEdit()"
                            class="p-button-sm p-button-secondary p-button-text inline-action-btn"
                            pTooltip="Deshacer (Escape)"
                        ></button>
                    </div>
                </td>

                <!-- Estado - TOGGLE -->
                <td>
                    <p-tag
                        [value]="getEstadoLabel(sucursal.estado)"
                        [severity]="getEstadoSeverity(sucursal.estado)"
                        (click)="toggleEstado(sucursal); $event.stopPropagation()"
                        class="cursor-pointer hover:opacity-80 transition-opacity"
                        title="Clic para cambiar"
                    ></p-tag>
                </td>

                <!-- Acciones -->
                <td (click)="$event.stopPropagation()">
                    <div class="flex gap-1">
                        <button
                            pButton
                            icon="pi pi-pencil"
                            (click)="openSucursalForm(sucursal)"
                            class="p-button-sm p-button-text p-button-warning"
                            pTooltip="Editar Sucursal"
                        ></button>
                        <button
                            pButton
                            icon="pi pi-trash"
                            (click)="eliminarSucursal(sucursal)"
                            class="p-button-sm p-button-text p-button-danger"
                            pTooltip="Eliminar Sucursal"
                        ></button>
                    </div>
                </td>
            </tr>
        </ng-template>
    </p-table>
</div>

<!-- Modal de formulario CRUD -->
<p-dialog
    [(visible)]="showSucursalModal"
    [header]="isEditingSucursal ? 'Editar Sucursal' : 'Nueva Sucursal'"
    [modal]="true"
    [style]="{width: '800px', maxWidth: '90vw'}"
    [draggable]="false"
    [resizable]="false"
    
    styleClass="banner-form-dialog"
>
    <form [formGroup]="sucursalForm" (ngSubmit)="saveSucursal()">
        <!-- Campos principales -->
        <div class="grid grid-cols-1 gap-4 mb-6">
            <!-- ID de la Sucursal -->
            <div>
                <p-floatLabel variant="on">
                    <input
                        pInputText
                        formControlName="sucursal"
                        type="number"
                        placeholder="ID de la sucursal"
                        class="w-full"
                        [readonly]="isEditingSucursal"
                        min="1"
                        [class.bg-gray-50]="isEditingSucursal"
                        [class.text-gray-500]="isEditingSucursal"
                    />
                    <label>ID Sucursal *</label>
                </p-floatLabel>
                <small *ngIf="isEditingSucursal" class="text-gray-500 text-xs mt-1 block">
                    El ID no se puede modificar en modo edici贸n
                </small>
            </div>

            <!-- Nombre -->
            <div>
                <p-floatLabel variant="on">
                    <input
                        pInputText
                        formControlName="tienda"
                        placeholder="Nombre descriptivo de la sucursal"
                        class="w-full"
                        maxlength="100"
                    />
                    <label>Nombre *</label>
                </p-floatLabel>
            </div>

            <!-- Direcci贸n -->
            <div>
                <p-floatLabel variant="on">
                    <input
                        pInputText
                        formControlName="direccion"
                        placeholder="Direcci贸n completa de la sucursal"
                        class="w-full"
                        maxlength="255"
                    />
                    <label>Direcci贸n *</label>
                </p-floatLabel>
            </div>

            <!-- Latitud y Longitud -->
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <p-floatLabel variant="on">
                        <input
                            pInputText
                            formControlName="latitud"
                            placeholder="32.532"
                            class="w-full"
                        />
                        <label>Latitud</label>
                    </p-floatLabel>
                </div>
                <div>
                    <p-floatLabel variant="on">
                        <input
                            pInputText
                            formControlName="longitud"
                            placeholder="-117.071"
                            class="w-full"
                        />
                        <label>Longitud</label>
                    </p-floatLabel>
                </div>
            </div>

            <!-- Zona Geogr谩fica y Estado -->
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <p-floatLabel variant="on">
                        <input
                            pInputText
                            type="number"
                            formControlName="zona_geografica"
                            placeholder="1"
                            class="w-full"
                            min="1"
                        />
                        <label>Zona Geogr谩fica</label>
                    </p-floatLabel>
                </div>
                <div class="flex items-center gap-4">
                    <p-tag
                        [value]="sucursalForm.get('estado')?.value === 'A' ? 'Activo' : 'Inactivo'"
                        [severity]="sucursalForm.get('estado')?.value === 'A' ? 'success' : 'danger'"
                        (click)="sucursalForm.patchValue({estado: sucursalForm.get('estado')?.value === 'A' ? 'I' : 'A'})"
                        class="cursor-pointer hover:opacity-80 transition-opacity"
                        pTooltip="Activar/desactivar sucursal"
                    ></p-tag>
                    <label class="text-sm text-gray-600">Estado</label>
                </div>
            </div>

            <!-- Tel茅fono -->
            <div>
                <p-floatLabel variant="on">
                    <input
                        pInputText
                        formControlName="telefono"
                        placeholder="(52) 55 1234 5678"
                        class="w-full"
                        maxlength="20"
                    />
                    <label>Tel茅fono</label>
                </p-floatLabel>
            </div>

            <!-- IP e IP_SERV -->
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <p-floatLabel variant="on">
                        <input
                            pInputText
                            formControlName="ip"
                            placeholder="192.168.1.100"
                            class="w-full"
                            maxlength="15"
                        />
                        <label>IP</label>
                    </p-floatLabel>
                </div>
                <div>
                    <p-floatLabel variant="on">
                        <input
                            pInputText
                            formControlName="ip_serv"
                            placeholder="10.0.0.1"
                            class="w-full"
                            maxlength="15"
                        />
                        <label>IP Servidor</label>
                    </p-floatLabel>
                </div>
            </div>

            <!-- SAP (Tag igual al Estado) -->
            <div class="flex items-center gap-4">
                <p-tag
                    [value]="getSapLabel(sucursalForm.get('sap')?.value)"
                    [severity]="getSapSeverity(sucursalForm.get('sap')?.value)"
                    (click)="toggleSap()"
                    class="cursor-pointer hover:opacity-80 transition-opacity"
                    pTooltip="Activar/desactivar integraci贸n SAP"
                ></p-tag>
                <label class="text-sm text-gray-600">SAP</label>
            </div>
        </div>

        <!-- Proyecto seleccionado (solo lectura) -->
        <div class="mb-6 p-4 bg-gray-50 rounded-lg" *ngIf="proyectoSeleccionado">
            <h4 class="text-lg font-semibold mb-3">Proyecto Asignado</h4>
            <div class="grid grid-cols-2 gap-4 text-sm">
                <div>
                                            <label class="font-medium text-gray-700">Proyecto:</label>
                                            <p class="text-gray-600">{{ getProyectoNombre(proyectoSeleccionado) }}</p>
                </div>
                <div>
                    <label class="font-medium text-gray-700">ID Proyecto:</label>
                    <p class="text-gray-600">{{ proyectoSeleccionado.id_proy }}</p>
                </div>
            </div>
        </div>

        <!-- Botones -->
        <div class="flex justify-end gap-2 pt-4 border-t border-gray-200">
            <button
                pButton
                type="button"
                (click)="showSucursalModal = false"
                label="Cancelar"
                class="p-button-text"
            ></button>
            <button
                pButton
                type="submit"
                [label]="isEditingSucursal ? 'Actualizar' : 'Crear'"
                [disabled]="!sucursalForm.valid || savingSucursal"
                [loading]="savingSucursal"
                class="p-button-success"
            ></button>
        </div>
    </form>
</p-dialog>

<!-- Modal de confirmaci贸n personalizado -->
<p-dialog
    header="{{confirmHeader}}"
    [(visible)]="showConfirmDialog"
    [modal]="true"
    [style]="{width: '450px'}"
    [closable]="true"
    (onHide)="cancelarConfirmacion()"
>
    <div class="flex align-items-center gap-3 mb-3">
        <i class="pi pi-exclamation-triangle text-orange-500 text-2xl"></i>
        <span class="text-lg">{{confirmMessage}}</span>
    </div>

    <div class="flex justify-content-end gap-2 mt-4">
        <p-button
            label="Cancelar"
            icon="pi pi-times"
            severity="secondary"
            (onClick)="cancelarConfirmacion()"
        ></p-button>
        <p-button
            label="S铆, Confirmar"
            icon="pi pi-check"
            severity="danger"
            (onClick)="confirmarAccion()"
        ></p-button>
    </div>
</p-dialog>
