import { Component, OnInit, inject } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormsModule } from '@angular/forms';

// PrimeNG Modules (standalone)
import { CardModule } from 'primeng/card';
import { ButtonModule } from 'primeng/button';
import { AutoCompleteModule } from 'primeng/autocomplete';
import { CheckboxModule } from 'primeng/checkbox';
// import { TabViewModule } from 'primeng/tabview'; // Temporalmente deshabilitado
import { ToastModule } from 'primeng/toast';
import { ProgressSpinnerModule } from 'primeng/progressspinner';
import { MessageService } from 'primeng/api';
import { TagModule } from 'primeng/tag';

// Modelos y servicios
import { Categoria, Subcategoria, Articulo } from '@/features/productos/models/index';
import { CategoriasService } from '@/features/productos/services/categorias.service';
import { SubcategoriasService } from '@/features/productos/services/subcategorias.service';
import { ArticulosService } from '@/features/productos/services/articulos.service';

@Component({
    selector: 'app-productos-test',
    standalone: true,
    imports: [
        CommonModule,
        FormsModule,
        CardModule,
        ButtonModule,
        AutoCompleteModule,
        CheckboxModule,
        ToastModule,
        ProgressSpinnerModule,
        TagModule
    ],
    template: `
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 p-6">

            <!-- Panel de Control -->
            <div class="space-y-6">

                <!-- Estado de Servicios -->
                <p-card header="Estado de Servicios">
                    <div class="space-y-3">
                        <div class="flex items-center justify-between">
                            <span class="font-medium">Categor√≠as:</span>
                            <p-tag
                                [value]="categoriasService ? 'Inicializado' : 'No Inicializado'"
                                [severity]="categoriasService ? 'success' : 'danger'"
                            ></p-tag>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="font-medium">Subcategor√≠as:</span>
                            <p-tag
                                [value]="subcategoriasService ? 'Inicializado' : 'No Inicializado'"
                                [severity]="subcategoriasService ? 'success' : 'danger'"
                            ></p-tag>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="font-medium">Cache Subcategor√≠as:</span>
                            <p-tag
                                [value]="subcategoriasCacheStatus.isLoaded ? 'Cargado' : 'No Cargado'"
                                [severity]="subcategoriasCacheStatus.isLoaded ? 'success' : 'warning'"
                            ></p-tag>
                        </div>
                        <div class="text-sm text-gray-600">
                            Subcategor√≠as en cache: {{ subcategoriasCacheStatus.count }}
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="font-medium">Art√≠culos:</span>
                            <p-tag
                                [value]="articulosService ? 'Inicializado' : 'No Inicializado'"
                                [severity]="articulosService ? 'success' : 'danger'"
                            ></p-tag>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="font-medium">Cache Art√≠culos:</span>
                            <p-tag
                                [value]="articulosCacheStatus.isLoaded ? 'Cargado' : 'No Cargado'"
                                [severity]="articulosCacheStatus.isLoaded ? 'success' : 'warning'"
                            ></p-tag>
                        </div>
                        <div class="text-sm text-gray-600">
                            Art√≠culos en cache: {{ articulosCacheStatus.count }}
                        </div>
                    </div>

                    <!-- Botones de Control -->
                    <ng-template pTemplate="footer">
                        <div class="flex gap-2">
                            <p-button
                                label="Inicializar Servicios"
                                icon="pi pi-play"
                                (onClick)="initializeServices()"
                                [loading]="loadingInit"
                                styleClass="p-button-sm"
                            ></p-button>
                            <p-button
                                label="Limpiar Cache"
                                icon="pi pi-trash"
                                (onClick)="clearCache()"
                                [disabled]="!subcategoriasCacheStatus.isLoaded"
                                styleClass="p-button-sm p-button-danger"
                            ></p-button>
                        </div>
                    </ng-template>
                </p-card>

                <!-- Navegaci√≥n entre secciones -->
                <p-card header="Navegaci√≥n de Secciones">
                    <div class="flex gap-2 mb-4">
                        <p-button
                            [label]="seccionActiva === 'categorias' ? 'üìÇ Categor√≠as & Subcategor√≠as' : 'üìÇ Categor√≠as'"
                            [outlined]="seccionActiva !== 'categorias'"
                            (onClick)="cambiarSeccion('categorias')"
                            styleClass="p-button-sm"
                        ></p-button>
                        <p-button
                            [label]="seccionActiva === 'articulos' ? 'üì¶ Art√≠culos' : 'üì¶ Art√≠culos'"
                            [outlined]="seccionActiva !== 'articulos'"
                            (onClick)="cambiarSeccion('articulos')"
                            styleClass="p-button-sm"
                        ></p-button>
                    </div>
                    <div class="text-sm text-gray-600">
                        <strong>Secci√≥n activa:</strong> {{ seccionActiva === 'categorias' ? 'Categor√≠as y Subcategor√≠as' : 'Art√≠culos' }}
                    </div>
                </p-card>

                <!-- Contenido de la secci√≥n activa -->
                <div *ngIf="seccionActiva === 'categorias'">

                        <!-- Selecci√≥n de Categor√≠a -->
                        <p-card header="Selecci√≥n de Categor√≠a">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Categor√≠a</label>
                                    <p-autocomplete
                                        [(ngModel)]="categoriaSeleccionada"
                                        [suggestions]="categoriasFiltradas"
                                        (completeMethod)="filtrarCategorias($event)"
                                        (onSelect)="onCategoriaSelect($event)"
                                        (onClear)="onCategoriaClear()"
                                        (ngModelChange)="onCategoriaModelChange($event)"
                                        (onDropdownClick)="onCategoriaDropdownShow()"
                                        field="nombre"
                                        optionLabel="nombre"
                                        placeholder="Buscar categor√≠a..."
                                        [dropdown]="true"
                                        [style]="{'width':'100%'}"
                                        [inputStyle]="{'width':'100%'}"
                                        [disabled]="!categoriasService"
                                        [showEmptyMessage]="true"
                                        emptyMessage="No se encontraron categor√≠as"
                                        [dataKey]="'idcat'"
                                    ></p-autocomplete>
                                </div>

                                <div *ngIf="categoriaSeleccionada">
                                    <p class="text-sm text-gray-600">
                                        <strong>ID Categor√≠a:</strong> {{ categoriaSeleccionada.idcat }}
                                    </p>
                                    <p class="text-sm text-gray-600">
                                        <strong>Nombre:</strong> {{ categoriaSeleccionada.nombre }}
                                    </p>
                                </div>

                                <p-button
                                    label="Cargar Categor√≠as"
                                    icon="pi pi-refresh"
                                    (onClick)="cargarCategorias()"
                                    [loading]="loadingCategorias"
                                    [disabled]="!categoriasService"
                                    styleClass="p-button-sm w-full"
                                ></p-button>
                    </div>
                </p-card>

                        <!-- Selecci√≥n de Subcategor√≠a -->
                        <p-card header="Selecci√≥n de Subcategor√≠a">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">
                                        Subcategor√≠a
                                        <span class="text-xs text-gray-500">(depende de categor√≠a)</span>
                                    </label>
                                    <p-autocomplete
                                        [(ngModel)]="subcategoriaSeleccionada"
                                        [suggestions]="subcategoriasFiltradas"
                                        (completeMethod)="filtrarSubcategorias($event)"
                                        (onSelect)="onSubcategoriaSelect($event)"
                                        (onClear)="onSubcategoriaClear()"
                                        (onDropdownClick)="onSubcategoriaDropdownShow()"
                                        field="nombre"
                                        optionLabel="nombre"
                                        [placeholder]="categoriaSeleccionada ? 'Buscar subcategor√≠a...' : 'Seleccione una categor√≠a primero'"
                                        [dropdown]="true"
                                        [style]="{'width':'100%'}"
                                        [inputStyle]="{'width':'100%'}"
                                        [disabled]="!categoriaSeleccionada || !subcategoriasService"
                                        [showEmptyMessage]="true"
                                        emptyMessage="No se encontraron subcategor√≠as"
                                        [dataKey]="'idscat'"
                                    ></p-autocomplete>
                                </div>

                                <div *ngIf="subcategoriaSeleccionada">
                                    <p class="text-sm text-gray-600">
                                        <strong>ID Subcategor√≠a:</strong> {{ subcategoriaSeleccionada.idscat }}
                                    </p>
                                    <p class="text-sm text-gray-600">
                                        <strong>ID Categor√≠a:</strong> {{ subcategoriaSeleccionada.idcat }}
                                    </p>
                                    <p class="text-sm text-gray-600">
                                        <strong>Nombre:</strong> {{ subcategoriaSeleccionada.nombre }}
                                    </p>
                                </div>

                                <!-- Configuraci√≥n de Compresi√≥n -->
                                <div class="p-3 bg-gray-50 rounded-lg">
                            <div class="flex items-center space-x-2 mb-2">
                                <p-checkbox
                                    name="usarCompresion"
                                    [(ngModel)]="usarCompresion"
                                    (onChange)="onCompresionChange($event)"
                                    label="Usar compresi√≥n">
                                </p-checkbox>
                                <p-tag
                                    [value]="usarCompresion ? 'COMPRIMIDO' : 'NORMAL'"
                                    [severity]="usarCompresion ? 'success' : 'info'">
                                </p-tag>
                            </div>
                            <p class="text-xs text-gray-600">
                                Activa la compresi√≥n para reducir el tama√±o de las respuestas HTTP
                            </p>
                        </div>

                        <div class="grid grid-cols-2 gap-2">
                            <p-button
                                label="Cargar Todas"
                                icon="pi pi-list"
                                (onClick)="cargarTodasSubcategorias()"
                                [loading]="loadingSubcategorias"
                                [disabled]="!categoriaSeleccionada || !subcategoriasService"
                                styleClass="p-button-sm"
                            ></p-button>
                            <p-button
                                label="Cargar Espec√≠fica"
                                icon="pi pi-search"
                                (onClick)="cargarSubcategoriaEspecifica()"
                                [loading]="loadingSubcategorias"
                                [disabled]="!categoriaSeleccionada || !subcategoriaSeleccionada || !subcategoriasService"
                                styleClass="p-button-sm"
                            ></p-button>
                        </div>

                            <p-button
                                label="Load Completo (LSCAT)"
                                icon="pi pi-download"
                                (onClick)="cargarCatalogoCompleto()"
                                [loading]="loadingInit"
                                [disabled]="!subcategoriasService"
                                styleClass="p-button-sm p-button-info w-full"
                                pTooltip="Carga todo el cat√°logo de subcategor√≠as en cache"
                            ></p-button>

                            <p-button
                                label="Debug URLs"
                                icon="pi pi-info-circle"
                                (onClick)="debugUrls()"
                                styleClass="p-button-sm p-button-secondary w-full"
                                pTooltip="Muestra informaci√≥n de debug de URLs"
                            ></p-button>

                            <div class="grid grid-cols-1 gap-2 mt-2">
                                <p-button
                                    label="üß™ Probar Compresi√≥n"
                                    icon="pi pi-flask"
                                    (onClick)="probarRespuestaComprimida()"
                                    styleClass="p-button-sm p-button-warning w-full"
                                    pTooltip="Probar formato de respuesta comprimida con datos de ejemplo"
                                ></p-button>

                                <p-button
                                    label="üî¨ Pruebas M√∫ltiples"
                                    icon="pi pi-search-plus"
                                    (onClick)="probarDiferentesEscenarios()"
                                    styleClass="p-button-sm p-button-info w-full"
                                    pTooltip="Ejecutar pruebas con diferentes escenarios de compresi√≥n"
                                ></p-button>

                                <p-button
                                    label="üóëÔ∏è Limpiar Respuestas"
                                    icon="pi pi-times"
                                    (onClick)="limpiarRespuestas()"
                                    styleClass="p-button-sm p-button-danger w-full"
                                    pTooltip="Limpiar todas las respuestas y m√©tricas"
                                ></p-button>
                            </div>
                    </div>
                </p-card>

                </div>

                <!-- Contenido de Art√≠culos -->
                <div *ngIf="seccionActiva === 'articulos'">

                    <!-- Gesti√≥n de Art√≠culos -->
                    <div class="space-y-6">
                        <p-card header="Gesti√≥n de Art√≠culos">
                            <div class="space-y-4">
                                <div class="grid grid-cols-1 gap-4">
                                    <div class="p-4 bg-blue-50 rounded-lg">
                                        <div class="flex items-center justify-between mb-2">
                                            <h4 class="font-medium text-blue-800">üì¶ Cache de Art√≠culos</h4>
                                            <p-tag
                                                [value]="articulosCacheStatus.isLoaded ? 'CARGADO' : 'VAC√çO'"
                                                [severity]="articulosCacheStatus.isLoaded ? 'success' : 'info'"
                                            ></p-tag>
                                        </div>
                                        <p class="text-sm text-blue-700 mb-2">
                                            Art√≠culos en cache: <strong>{{ articulosCacheStatus.count }}</strong>
                                        </p>
                                        <div class="text-xs text-blue-600">
                                            <p>Las consultas GET y SL responden desde cache si est√° disponible</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- Selecci√≥n de Art√≠culo -->
                                <div>
                                    <label class="block text-sm font-medium mb-2">Buscar Art√≠culo</label>
                                    <p-autocomplete
                                        [(ngModel)]="articuloSeleccionado"
                                        [suggestions]="articulosFiltrados"
                                        (completeMethod)="filtrarArticulos($event)"
                                        (onSelect)="onArticuloSelect($event)"
                                        (onClear)="onArticuloClear()"
                                        (onDropdownClick)="filtrarArticulos({ query: '' })"
                                        field="nombre"
                                        optionLabel="nombre"
                                        placeholder="Buscar art√≠culo por nombre, marca o c√≥digo..."
                                        [dropdown]="true"
                                        [style]="{'width':'100%'}"
                                        [inputStyle]="{'width':'100%'}"
                                        [disabled]="!articulosService"
                                        [showEmptyMessage]="true"
                                        emptyMessage="No se encontraron art√≠culos"
                                        [dataKey]="'articulo'"
                                        pTooltip="Busca art√≠culos por nombre, marca o c√≥digo de art√≠culo"
                                    ></p-autocomplete>
                                </div>

                                <div *ngIf="articuloSeleccionado" class="p-3 bg-green-50 rounded-lg">
                                    <h5 class="font-medium text-green-800 mb-2">üìã Art√≠culo Seleccionado</h5>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm">
                                        <div><strong>C√≥digo:</strong> {{ articuloSeleccionado.articulo }}</div>
                                        <div><strong>Marca:</strong> {{ articuloSeleccionado.marca }}</div>
                                        <div><strong>Nombre:</strong> {{ articuloSeleccionado.nombre }}</div>
                                        <div><strong>Estado:</strong>
                                            <p-tag
                                                [value]="articuloSeleccionado.estado_articulo"
                                                [severity]="articuloSeleccionado.estado_articulo === 'A' ? 'success' : 'danger'"
                                            ></p-tag>
                                        </div>
                                    </div>
                                </div>

                                <!-- Configuraci√≥n de Compresi√≥n para Art√≠culos -->
                                <div class="p-3 bg-purple-50 rounded-lg">
                                    <div class="flex items-center space-x-2 mb-2">
                                        <p-checkbox
                                            name="usarCompresionArticulos"
                                            [(ngModel)]="usarCompresionArticulos"
                                            (onChange)="onCompresionArticulosChange($event)"
                                            label="Usar compresi√≥n">
                                        </p-checkbox>
                                        <p-tag
                                            [value]="usarCompresionArticulos ? 'COMPRIMIDO' : 'NORMAL'"
                                            [severity]="usarCompresionArticulos ? 'success' : 'info'"
                                        ></p-tag>
                                    </div>
                                    <p class="text-xs text-purple-600">
                                        Activa la compresi√≥n para reducir el tama√±o de las respuestas HTTP de art√≠culos
                                    </p>
                                </div>

                                <div class="grid grid-cols-1 gap-2">
                                    <p-button
                                        label="Load Completo (LGET)"
                                        icon="pi pi-download"
                                        (onClick)="cargarCatalogoCompletoArticulos()"
                                        [loading]="loadingArticulos"
                                        [disabled]="!articulosService"
                                        styleClass="p-button-sm p-button-success w-full"
                                        pTooltip="Carga todo el cat√°logo de art√≠culos en cache"
                                    ></p-button>

                                    <p-button
                                        label="Cargar Art√≠culo Espec√≠fico"
                                        icon="pi pi-search"
                                        (onClick)="cargarArticuloEspecifico()"
                                        [loading]="loadingArticulos"
                                        [disabled]="!articuloSeleccionado || !articulosService"
                                        styleClass="p-button-sm p-button-primary w-full"
                                        pTooltip="Carga el art√≠culo espec√≠fico seleccionado"
                                    ></p-button>

                                    <p-button
                                        label="Limpiar Cache Art√≠culos"
                                        icon="pi pi-trash"
                                        (onClick)="clearArticulosCache()"
                                        [disabled]="!articulosService"
                                        styleClass="p-button-sm p-button-danger w-full"
                                        pTooltip="Limpia el cache de art√≠culos"
                                    ></p-button>
                                </div>
                            </div>
                        </p-card>
                    </div>

                </div>

            </div>

            <!-- Visualizaci√≥n de Respuestas Comprimidas -->
            <div class="space-y-6">
                <p-card header="üìä Visualizaci√≥n de Respuestas">
                    <div class="space-y-4">
                        <!-- Informaci√≥n de compresi√≥n -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div class="p-3 bg-green-50 rounded-lg">
                                <h5 class="font-medium text-green-800 mb-1">üì¶ Raw Response</h5>
                                <p class="text-sm text-green-700">{{ respuestaCruda?.length || 0 }} chars</p>
                                <p class="text-xs text-green-600">Tama√±o HTTP recibido</p>
                            </div>
                            <div class="p-3 bg-blue-50 rounded-lg">
                                <h5 class="font-medium text-blue-800 mb-1">üìã Processed Data</h5>
                                <p class="text-sm text-blue-700">{{ respuestaProcesada?.length || 0 }} chars</p>
                                <p class="text-xs text-blue-600">Datos listos para usar</p>
                            </div>
                            <div class="p-3 bg-purple-50 rounded-lg">
                                <h5 class="font-medium text-purple-800 mb-1">üóúÔ∏è Algorithm</h5>
                                <p class="text-sm text-purple-700">{{ algoritmoDetectado || 'N/A' }}</p>
                                <p class="text-xs text-purple-600">{{ metricasCompresion?.algoritmo || 'Sin comprimir' }}</p>
                            </div>
                            <div class="p-3 bg-orange-50 rounded-lg">
                                <h5 class="font-medium text-orange-800 mb-1">üìä Compression Ratio</h5>
                                <p class="text-sm text-orange-700">{{ calcularRatioCompresion() }}%</p>
                                <p class="text-xs text-orange-600">
                                    {{ metricasCompresion ? 'Comprimido' : 'Sin compresi√≥n' }}
                                </p>
                            </div>
                        </div>

                        <!-- M√©tricas detalladas (solo si hay compresi√≥n) -->
                        <div *ngIf="metricasCompresion" class="mt-4 p-4 bg-indigo-50 rounded-lg">
                            <h6 class="font-medium text-indigo-800 mb-2">üìà M√©tricas de Descompresi√≥n</h6>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                                <div>
                                    <span class="text-indigo-600">Original:</span>
                                    <span class="font-medium">{{ metricasCompresion.tamanoOriginal }} bytes</span>
                                </div>
                                <div>
                                    <span class="text-indigo-600">Descomprimido:</span>
                                    <span class="font-medium">{{ metricasCompresion.tamanoDescomprimido }} bytes</span>
                                </div>
                                <div>
                                    <span class="text-indigo-600">Ratio:</span>
                                    <span class="font-medium">{{ metricasCompresion.ratio }}%</span>
                                </div>
                                <div>
                                    <span class="text-indigo-600">Tiempo:</span>
                                    <span class="font-medium">{{ metricasCompresion.tiempoProcesamiento.toFixed(2) }}ms</span>
                                </div>
                            </div>
                        </div>

                        <!-- √Årea para respuesta cruda -->
                        <div>
                            <label class="block text-sm font-medium mb-2">üîç Respuesta Cruda del Servidor:</label>
                            <textarea
                                [value]="respuestaCruda"
                                readonly
                                rows="8"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md font-mono text-xs bg-gray-50"
                                placeholder="Aqu√≠ aparecer√° la respuesta HTTP sin procesar...">
                            </textarea>
                        </div>

                        <!-- √Årea para respuesta procesada -->
                        <div>
                            <label class="block text-sm font-medium mb-2">‚úÖ Datos Procesados:</label>
                            <textarea
                                [value]="respuestaProcesada"
                                readonly
                                rows="8"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md font-mono text-xs bg-green-50"
                                placeholder="Aqu√≠ aparecer√°n los datos despu√©s de descompresi√≥n...">
                            </textarea>
                        </div>
                    </div>
                </p-card>

                <!-- Visualizaci√≥n de Respuestas Comprimidas - Art√≠culos -->
                <p-card header="üì¶ Visualizaci√≥n de Respuestas - Art√≠culos">
                    <div class="space-y-4">
                        <!-- Informaci√≥n de compresi√≥n para art√≠culos -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div class="p-3 bg-green-50 rounded-lg">
                                <h5 class="font-medium text-green-800 mb-1">üì¶ Raw Response</h5>
                                <p class="text-sm text-green-700">{{ respuestaCrudaArticulos?.length || 0 }} chars</p>
                                <p class="text-xs text-green-600">Tama√±o HTTP recibido</p>
                            </div>
                            <div class="p-3 bg-blue-50 rounded-lg">
                                <h5 class="font-medium text-blue-800 mb-1">üìã Processed Data</h5>
                                <p class="text-sm text-blue-700">{{ respuestaProcesadaArticulos?.length || 0 }} chars</p>
                                <p class="text-xs text-blue-600">Datos listos para usar</p>
                            </div>
                            <div class="p-3 bg-purple-50 rounded-lg">
                                <h5 class="font-medium text-purple-800 mb-1">üóúÔ∏è Algorithm</h5>
                                <p class="text-sm text-purple-700">{{ algoritmoDetectadoArticulos || 'N/A' }}</p>
                                <p class="text-xs text-purple-600">{{ metricasCompresionArticulos?.algoritmo || 'Sin comprimir' }}</p>
                            </div>
                            <div class="p-3 bg-orange-50 rounded-lg">
                                <h5 class="font-medium text-orange-800 mb-1">üìä Compression Ratio</h5>
                                <p class="text-sm text-orange-700">{{ calcularRatioCompresionArticulos() }}%</p>
                                <p class="text-xs text-orange-600">
                                    {{ metricasCompresionArticulos ? 'Comprimido' : 'Sin compresi√≥n' }}
                                </p>
                            </div>
                        </div>

                        <!-- M√©tricas detalladas para art√≠culos (solo si hay compresi√≥n) -->
                        <div *ngIf="metricasCompresionArticulos" class="mt-4 p-4 bg-indigo-50 rounded-lg">
                            <h6 class="font-medium text-indigo-800 mb-2">üìà M√©tricas de Descompresi√≥n - Art√≠culos</h6>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                                <div>
                                    <span class="text-indigo-600">Original:</span>
                                    <span class="font-medium">{{ metricasCompresionArticulos.tamanoOriginal }} bytes</span>
                                </div>
                                <div>
                                    <span class="text-indigo-600">Descomprimido:</span>
                                    <span class="font-medium">{{ metricasCompresionArticulos.tamanoDescomprimido }} bytes</span>
                                </div>
                                <div>
                                    <span class="text-indigo-600">Ratio:</span>
                                    <span class="font-medium">{{ metricasCompresionArticulos.ratio }}%</span>
                                </div>
                                <div>
                                    <span class="text-indigo-600">Tiempo:</span>
                                    <span class="font-medium">{{ metricasCompresionArticulos.tiempoProcesamiento.toFixed(2) }}ms</span>
                                </div>
                            </div>
                        </div>

                        <!-- √Årea para respuesta cruda de art√≠culos -->
                        <div>
                            <label class="block text-sm font-medium mb-2">üîç Respuesta Cruda del Servidor (Art√≠culos):</label>
                            <textarea
                                [value]="respuestaCrudaArticulos"
                                readonly
                                rows="6"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md font-mono text-xs bg-gray-50"
                                placeholder="Aqu√≠ aparecer√° la respuesta HTTP de art√≠culos sin procesar...">
                            </textarea>
                        </div>

                        <!-- √Årea para respuesta procesada de art√≠culos -->
                        <div>
                            <label class="block text-sm font-medium mb-2">‚úÖ Datos Procesados (Art√≠culos):</label>
                            <textarea
                                [value]="respuestaProcesadaArticulos"
                                readonly
                                rows="6"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md font-mono text-xs bg-green-50"
                                placeholder="Aqu√≠ aparecer√°n los datos de art√≠culos despu√©s de descompresi√≥n...">
                            </textarea>
                        </div>

                        <!-- Botones de prueba para art√≠culos -->
                        <div class="grid grid-cols-1 gap-2 mt-2">
                            <p-button
                                label="üß™ Probar Compresi√≥n Art√≠culos"
                                icon="pi pi-flask"
                                (onClick)="probarRespuestaComprimida()"
                                styleClass="p-button-sm p-button-warning w-full"
                                pTooltip="Probar formato de respuesta comprimida con datos de ejemplo para art√≠culos"
                            ></p-button>

                            <p-button
                                label="üóëÔ∏è Limpiar Respuestas Art√≠culos"
                                icon="pi pi-times"
                                (onClick)="limpiarRespuestasArticulos()"
                                styleClass="p-button-sm p-button-danger w-full"
                                pTooltip="Limpiar todas las respuestas y m√©tricas de art√≠culos"
                            ></p-button>
                        </div>
                    </div>
                </p-card>

                        <!-- Gesti√≥n de Art√≠culos -->
                        <div class="space-y-6">
                            <p-card header="Gesti√≥n de Art√≠culos">
                                <div class="space-y-4">
                                    <div class="grid grid-cols-1 gap-4">
                                        <div class="p-4 bg-blue-50 rounded-lg">
                                            <div class="flex items-center justify-between mb-2">
                                                <h4 class="font-medium text-blue-800">üì¶ Cache de Art√≠culos</h4>
                                                <p-tag
                                                    [value]="articulosCacheStatus.isLoaded ? 'CARGADO' : 'VAC√çO'"
                                                    [severity]="articulosCacheStatus.isLoaded ? 'success' : 'info'"
                                                ></p-tag>
                                            </div>
                                            <p class="text-sm text-blue-700 mb-2">
                                                Art√≠culos en cache: <strong>{{ articulosCacheStatus.count }}</strong>
                                            </p>
                                            <div class="text-xs text-blue-600">
                                                <p>Las consultas GET y SL responden desde cache si est√° disponible</p>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Selecci√≥n de Art√≠culo -->
                                    <div>
                                        <label class="block text-sm font-medium mb-2">Buscar Art√≠culo</label>
                                        <p-autocomplete
                                            [(ngModel)]="articuloSeleccionado"
                                            [suggestions]="articulosFiltrados"
                                            (completeMethod)="filtrarArticulos($event)"
                                            (onSelect)="onArticuloSelect($event)"
                                            (onClear)="onArticuloClear()"
                                            (onDropdownClick)="filtrarArticulos({ query: '' })"
                                            field="nombre"
                                            optionLabel="nombre"
                                            placeholder="Buscar art√≠culo por nombre, marca o c√≥digo..."
                                            [dropdown]="true"
                                            [style]="{'width':'100%'}"
                                            [inputStyle]="{'width':'100%'}"
                                            [disabled]="!articulosService"
                                            [showEmptyMessage]="true"
                                            emptyMessage="No se encontraron art√≠culos"
                                            [dataKey]="'articulo'"
                                            pTooltip="Busca art√≠culos por nombre, marca o c√≥digo de art√≠culo"
                                        ></p-autocomplete>
                                    </div>

                                    <div *ngIf="articuloSeleccionado" class="p-3 bg-green-50 rounded-lg">
                                        <h5 class="font-medium text-green-800 mb-2">üìã Art√≠culo Seleccionado</h5>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm">
                                            <div><strong>C√≥digo:</strong> {{ articuloSeleccionado.articulo }}</div>
                                            <div><strong>Marca:</strong> {{ articuloSeleccionado.marca }}</div>
                                            <div><strong>Nombre:</strong> {{ articuloSeleccionado.nombre }}</div>
                                            <div><strong>Estado:</strong>
                                                <p-tag
                                                    [value]="articuloSeleccionado.estado_articulo"
                                                    [severity]="articuloSeleccionado.estado_articulo === 'A' ? 'success' : 'danger'"
                                                ></p-tag>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Configuraci√≥n de Compresi√≥n para Art√≠culos -->
                                    <div class="p-3 bg-purple-50 rounded-lg">
                                        <div class="flex items-center space-x-2 mb-2">
                                            <p-checkbox
                                                name="usarCompresionArticulos"
                                                [(ngModel)]="usarCompresionArticulos"
                                                (onChange)="onCompresionArticulosChange($event)"
                                                label="Usar compresi√≥n">
                                            </p-checkbox>
                                            <p-tag
                                                [value]="usarCompresionArticulos ? 'COMPRIMIDO' : 'NORMAL'"
                                                [severity]="usarCompresionArticulos ? 'success' : 'info'"
                                            ></p-tag>
                                        </div>
                                        <p class="text-xs text-purple-600">
                                            Activa la compresi√≥n para reducir el tama√±o de las respuestas HTTP de art√≠culos
                                        </p>
                                    </div>

                                    <div class="grid grid-cols-1 gap-2">
                                        <p-button
                                            label="Load Completo (LGET)"
                                            icon="pi pi-download"
                                            (onClick)="cargarCatalogoCompletoArticulos()"
                                            [loading]="loadingArticulos"
                                            [disabled]="!articulosService"
                                            styleClass="p-button-sm p-button-success w-full"
                                            pTooltip="Carga todo el cat√°logo de art√≠culos en cache"
                                        ></p-button>

                                        <p-button
                                            label="Cargar Art√≠culo Espec√≠fico"
                                            icon="pi pi-search"
                                            (onClick)="cargarArticuloEspecifico()"
                                            [loading]="loadingArticulos"
                                            [disabled]="!articuloSeleccionado || !articulosService"
                                            styleClass="p-button-sm p-button-primary w-full"
                                            pTooltip="Carga el art√≠culo espec√≠fico seleccionado"
                                        ></p-button>

                                        <p-button
                                            label="Limpiar Cache Art√≠culos"
                                            icon="pi pi-trash"
                                            (onClick)="clearArticulosCache()"
                                            [disabled]="!articulosService"
                                            styleClass="p-button-sm p-button-danger w-full"
                                            pTooltip="Limpia el cache de art√≠culos"
                                        ></p-button>
                                    </div>
                                </div>
                            </p-card>
                        </div>

                        </div>

            </div>

            <!-- Panel de Resultados -->
            <div class="space-y-6">

                <!-- Resultados seg√∫n secci√≥n activa -->
                <div *ngIf="seccionActiva === 'categorias'">
                    <!-- Resultados de Categor√≠as -->
                    <p-card header="Resultado de Categor√≠as">
                        <div *ngIf="categorias.length === 0 && !loadingCategorias" class="text-center py-8 text-gray-500">
                            <i class="pi pi-folder text-3xl mb-2"></i>
                            <p>No hay categor√≠as cargadas</p>
                        </div>

                        <div *ngIf="categorias.length > 0" class="space-y-2">
                            <div *ngFor="let cat of categorias" class="flex items-center justify-between p-2 bg-gray-50 rounded">
                                <div>
                                    <span class="font-medium">{{ cat.nombre }}</span>
                                    <span class="text-sm text-gray-500 ml-2">(ID: {{ cat.idcat }})</span>
                                </div>
                                <p-tag
                                    [value]="categoriaSeleccionada?.idcat === cat.idcat ? 'Seleccionada' : 'Disponible'"
                                    [severity]="categoriaSeleccionada?.idcat === cat.idcat ? 'success' : 'info'"
                                ></p-tag>
                            </div>
                        </div>

                        <div *ngIf="loadingCategorias" class="text-center py-4">
                            <p-progressSpinner [style]="{'width': '30px', 'height': '30px'}"></p-progressSpinner>
                            <p class="mt-2 text-sm text-gray-600">Cargando categor√≠as...</p>
                        </div>
                    </p-card>
                </div>

                <div *ngIf="seccionActiva === 'articulos'">
                    <!-- Resultados de Art√≠culos -->
                    <p-card header="Resultado de Art√≠culos">
                        <div *ngIf="articulos.length === 0 && !loadingArticulos" class="text-center py-8 text-gray-500">
                            <i class="pi pi-box text-3xl mb-2"></i>
                            <p>No hay art√≠culos cargados</p>
                            <p class="text-xs mt-1">Use "Load Completo" o busque un art√≠culo espec√≠fico</p>
                        </div>

                        <div *ngIf="articulos.length > 0" class="space-y-2">
                            <div *ngFor="let art of articulos" class="flex items-center justify-between p-2 bg-green-50 rounded">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2">
                                        <span class="font-medium">{{ art.nombre }}</span>
                                        <p-tag
                                            [value]="art.estado_articulo"
                                            [severity]="art.estado_articulo === 'A' ? 'success' : 'danger'"
                                            styleClass="text-xs"
                                        ></p-tag>
                                    </div>
                                    <div class="text-sm text-gray-500 mt-1">
                                        <span class="font-medium">{{ art.articulo }}</span> |
                                        {{ art.marca }} |
                                        Cat: {{ art.idcat }}, Sub: {{ art.idscat }}
                                    </div>
                                </div>
                                <p-tag
                                    [value]="articuloSeleccionado?.articulo === art.articulo ? 'Seleccionado' : 'Disponible'"
                                    [severity]="articuloSeleccionado?.articulo === art.articulo ? 'success' : 'info'"
                                ></p-tag>
                            </div>
                        </div>

                        <div *ngIf="loadingArticulos" class="text-center py-4">
                            <p-progressSpinner [style]="{'width': '30px', 'height': '30px'}"></p-progressSpinner>
                            <p class="mt-2 text-sm text-gray-600">Cargando art√≠culos...</p>
                        </div>
                    </p-card>
                </div>


                <!-- Informaci√≥n T√©cnica -->
                <p-card header="Informaci√≥n T√©cnica">
                    <div class="space-y-3 text-sm">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <h5 class="font-medium mb-2">üîå API Configuration</h5>
                                <ul class="space-y-1 text-gray-600">
                                    <li><strong>Endpoint ID:</strong> 12 (compartido)</li>
                                    <li><strong>M√©todo:</strong> POST</li>
                                    <li><strong>Actions soportados:</strong> GET, SL, CAT, LSCAT</li>
                                    <li><strong>Action por defecto:</strong> SL/CAT (seg√∫n servicio)</li>
                                    <li><strong>Inyecci√≥n de sesi√≥n:</strong> ‚úÖ Autom√°tica</li>
                                    <li><strong>Configuraci√≥n din√°mica:</strong> ‚úÖ ApiConfigService</li>
                                </ul>
                            </div>
                            <div>
                                <h5 class="font-medium mb-2">üé® PrimeNG Autocomplete + Dropdown</h5>
                                <ul class="space-y-1 text-gray-600">
                                    <li><strong>Componente:</strong> p-autocomplete</li>
                                    <li><strong>B√∫squeda:</strong> ‚úÖ En tiempo real mientras escribes</li>
                                    <li><strong>Dropdown:</strong> ‚úÖ Bot√≥n para ver lista completa</li>
                                    <li><strong>Loading states:</strong> Gesti√≥n externa</li>
                                    <li><strong>Disabled states:</strong> ‚úÖ Condicional</li>
                                    <li><strong>Filtrado din√°mico:</strong> ‚úÖ Mientras escribes</li>
                                    <li><strong>Mensajes vac√≠os:</strong> ‚úÖ Personalizables</li>
                                    <li><strong>Navegaci√≥n:</strong> ‚úÖ Teclado completa</li>
                                </ul>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                            <div class="p-3 bg-yellow-50 rounded">
                                <p class="text-xs text-yellow-800">
                                    <strong>üí° Cache Tip:</strong> Use "Load Completo" una vez para activar el cache inteligente.
                                    Las consultas posteriores ser√°n instant√°neas desde memoria.
                                </p>
                            </div>
                            <div class="p-3 bg-blue-50 rounded">
                                <p class="text-xs text-blue-800">
                                    <strong>üéØ Autocomplete + Dropdown Features:</strong> B√∫squeda inteligente mientras escribes,
                                    bot√≥n dropdown para ver lista completa, filtrado autom√°tico de opciones,
                                    selecci√≥n visual clara y navegaci√≥n por teclado intuitiva.
                                </p>
                            </div>
                        </div>
                    </div>
                </p-card>

            </div>

        </div>

        <!-- Toast para mensajes -->
        <p-toast></p-toast>
    `,
    styles: [`
        .p-card-header {
            font-weight: 600;
            color: #374151;
        }

        .p-autocomplete {
            width: 100%;
        }

        .p-autocomplete-input {
            width: 100% !important;
        }

        .p-tag {
            font-size: 0.75rem;
        }
    `]
})
export class ProductosTestComponent implements OnInit {

    // Servicios (p√∫blicos para acceso desde template)
    categoriasService = inject(CategoriasService);
    subcategoriasService = inject(SubcategoriasService);
    articulosService = inject(ArticulosService);
    private messageService = inject(MessageService);

    // Estados de carga
    loadingInit = false;
    loadingCategorias = false;
    loadingSubcategorias = false;
    loadingArticulos = false;

    // Datos
    categorias: Categoria[] = [];
    subcategorias: Subcategoria[] = [];
    articulos: Articulo[] = [];

    // Selecciones
    categoriaSeleccionada: Categoria | null = null;
    subcategoriaSeleccionada: Subcategoria | null = null;
    articuloSeleccionado: Articulo | null = null;

    // Para autocomplete
    categoriasFiltradas: Categoria[] = [];
    subcategoriasFiltradas: Subcategoria[] = [];
    articulosFiltrados: Articulo[] = [];

    // Estado del cache
    subcategoriasCacheStatus = { isLoaded: false, count: 0 };
    articulosCacheStatus = { isLoaded: false, count: 0 };

    // Configuraci√≥n de compresi√≥n
    usarCompresion: boolean = false;
    usarCompresionArticulos: boolean = false;
    respuestaCruda: string = '';
    respuestaProcesada: string = '';
    respuestaCrudaArticulos: string = '';
    respuestaProcesadaArticulos: string = '';
    algoritmoDetectado: string = '';
    algoritmoDetectadoArticulos: string = '';
    metricasCompresion: {
      algoritmo: string;
      ratio: number;
      tiempoProcesamiento: number;
      tamanoOriginal: number;
      tamanoDescomprimido: number;
    } | null = null;
    metricasCompresionArticulos: {
      algoritmo: string;
      ratio: number;
      tiempoProcesamiento: number;
      tamanoOriginal: number;
      tamanoDescomprimido: number;
    } | null = null;

    // Navegaci√≥n entre secciones
    seccionActiva: 'categorias' | 'articulos' = 'categorias';

    // Datos de prueba para compresi√≥n
    private respuestaComprimidaSimulada = {
        "statuscode": 200,
        "mensaje": "Ok",
        "data": [
            {
                "data": {
                    "type": "Buffer",
                    "data": [
                        31, 139, 8, 0, 0, 0, 0, 0, 4, 0, 117, 80, 219, 10, 130, 80, 16, 156,
                        79, 17, 159, 203, 46, 80, 15, 190, 133, 69, 4, 93, 32, 165, 151, 138,
                        40, 21, 51, 204, 34, 21, 130, 232, 223, 27, 215, 83, 41, 22, 178, 199,
                        179, 179, 51, 179, 123, 118, 141, 7, 116, 236, 113, 67, 138, 16, 46,
                        50, 68, 184, 16, 49, 209, 65, 27, 61, 70, 131, 89, 76, 236, 140, 3,
                        89, 190, 212, 116, 12, 96, 97, 132, 9, 28, 158, 26, 191, 21, 255, 99,
                        134, 195, 202, 84, 16, 11, 75, 214, 237, 18, 210, 129, 65, 63, 13,
                        77, 198, 148, 184, 46, 222, 103, 233, 238, 242, 44, 156, 171, 186,
                        130, 19, 194, 19, 70, 170, 38, 203, 177, 34, 159, 215, 38, 179, 176,
                        192, 140, 14, 67, 234, 191, 234, 164, 164, 239, 10, 154, 252, 117,
                        40, 191, 205, 174, 120, 248, 8, 132, 211, 87, 14, 121, 94, 215, 87,
                        119, 81, 232, 125, 178, 83, 246, 243, 200, 222, 253, 220, 183, 254,
                        153, 55, 99, 53, 34, 43, 164, 111, 160, 106, 71, 242, 83, 92, 233,
                        98, 98, 131, 150, 68, 40, 187, 11, 232, 29, 139, 191, 33, 47, 138,
                        20, 126, 199, 73, 97, 249, 124, 111, 126, 32, 183, 132, 247, 184,
                        162, 55, 200, 190, 74, 183, 39, 182, 120, 1, 31, 245, 16, 191, 22,
                        2, 0, 0
                    ]
                }
            }
        ],
        "swcomp": 1
    };

    ngOnInit(): void {
        console.log('üöÄ ProductosTestComponent inicializado');
        this.actualizarEstadoCache();

        // Configurar callback para mostrar respuestas crudas
        this.subcategoriasService.setRespuestaCrudaCallback((respuesta) => {
            this.mostrarRespuestaCruda(respuesta);
        });

        // Configurar callback para art√≠culos
        this.articulosService.setRespuestaCrudaCallback((respuesta) => {
            this.mostrarRespuestaCrudaArticulos(respuesta);
        });
    }

    // ========== COMPRESI√ìN ==========

    onCompresionChange(event: any): void {
        this.usarCompresion = event.checked;
        console.log('üîß Compresi√≥n:', this.usarCompresion ? 'ACTIVADA' : 'DESACTIVADA');
    }

    mostrarRespuestaCruda(respuesta: any): void {
        this.respuestaCruda = JSON.stringify(respuesta, null, 2);

        // Detectar algoritmo usado y m√©tricas
        if (respuesta.swcomp === 1) {
            // Si viene swcomp=1, los datos est√°n comprimidos
            this.algoritmoDetectado = 'GZIP (DETECTADO)';

            // Calcular m√©tricas b√°sicas
            const tamanoCrudo = this.respuestaCruda.length;
            // El tama√±o descomprimido se calcular√° cuando se procesen los datos

            this.metricasCompresion = {
                algoritmo: 'GZIP',
                ratio: 0, // Se calcular√° despu√©s
                tiempoProcesamiento: 0, // Se calcular√° despu√©s
                tamanoOriginal: tamanoCrudo,
                tamanoDescomprimido: 0 // Se calcular√° despu√©s
            };
        } else {
            this.algoritmoDetectado = 'SIN COMPRESI√ìN';
            this.metricasCompresion = null;
        }
    }

    calcularRatioCompresion(): string {
        if (!this.respuestaCruda || !this.respuestaProcesada) return '0';
        const ratio = ((this.respuestaCruda.length - this.respuestaProcesada.length) / this.respuestaCruda.length * 100);
        return ratio.toFixed(1);
    }

    // ========== PRUEBAS DE COMPRESI√ìN ==========

    /**
     * M√©todo para probar el formato de respuesta comprimida exacto
     */
    probarRespuestaComprimida(): void {
        console.log('üß™ Probando formato de respuesta comprimida...');

        // Simular la respuesta exacta que proporcion√≥ el usuario
        const respuestaComprimidaSimulada = {
            "statuscode": 200,
            "mensaje": "Ok",
            "data": [
                {
                    "data": {
                        "type": "Buffer",
                        "data": [
                            31, 139, 8, 0, 0, 0, 0, 0, 4, 0, 117, 80, 219, 10, 130, 80, 16, 156,
                            79, 17, 159, 203, 46, 80, 15, 190, 133, 69, 4, 93, 32, 165, 151, 138,
                            40, 21, 51, 204, 34, 21, 130, 232, 223, 27, 215, 83, 41, 22, 178, 199,
                            179, 179, 51, 179, 123, 118, 141, 7, 116, 236, 113, 67, 138, 16, 46,
                            50, 68, 184, 16, 49, 209, 65, 27, 61, 70, 131, 89, 76, 236, 140, 3,
                            89, 190, 212, 116, 12, 96, 97, 132, 9, 28, 158, 26, 191, 21, 255, 99,
                            134, 195, 202, 84, 16, 11, 75, 214, 237, 18, 210, 129, 65, 63, 13,
                            77, 198, 148, 184, 46, 222, 103, 233, 238, 242, 44, 156, 171, 186,
                            130, 19, 194, 19, 70, 170, 38, 203, 177, 34, 159, 215, 38, 179, 176,
                            192, 140, 14, 67, 234, 191, 234, 164, 164, 239, 10, 154, 252, 117,
                            40, 191, 205, 174, 120, 248, 8, 132, 211, 87, 14, 121, 94, 215, 87,
                            119, 81, 232, 125, 178, 83, 246, 243, 200, 222, 253, 220, 183, 254,
                            153, 55, 99, 53, 34, 43, 164, 111, 160, 106, 71, 242, 83, 92, 233,
                            98, 98, 131, 150, 68, 40, 187, 11, 232, 29, 139, 191, 33, 47, 138,
                            20, 126, 199, 73, 97, 249, 124, 111, 126, 32, 183, 132, 247, 184,
                            162, 55, 200, 190, 74, 183, 39, 182, 120, 1, 31, 245, 16, 191, 22,
                            2, 0, 0
                        ]
                    }
                }
            ],
            "swcomp": 1
        };

        // Mostrar la respuesta cruda
        this.mostrarRespuestaCruda(respuestaComprimidaSimulada);

        // Intentar descomprimir usando el servicio
        try {
            const decompressionResult = this.subcategoriasService['compressionService'].detectAndDecompress(respuestaComprimidaSimulada.data[0]);

            console.log('‚úÖ Descompresi√≥n de prueba exitosa:', decompressionResult);

            // Mostrar datos descomprimidos - manejar tanto JSON como texto plano
            try {
                // Intentar formatear como JSON si es posible
                const parsedData = JSON.parse(decompressionResult.data);
                this.respuestaProcesada = JSON.stringify(parsedData, null, 2);
                console.log('üìã Datos parseados como JSON correctamente');
            } catch (jsonError) {
                // Si no es JSON v√°lido, mostrar como texto plano
                console.log('üìÑ Datos no son JSON v√°lido, mostrando como texto plano');
                this.respuestaProcesada = decompressionResult.data;
            }

            // Actualizar m√©tricas
            if (this.metricasCompresion) {
                this.metricasCompresion.tamanoDescomprimido = this.respuestaProcesada.length;
                this.metricasCompresion.ratio = decompressionResult.compressionRatio;
                this.metricasCompresion.tiempoProcesamiento = decompressionResult.processingTime;
                this.metricasCompresion.algoritmo = decompressionResult.algorithm;
            }

            this.messageService.add({
                severity: 'success',
                summary: 'Prueba Exitosa',
                detail: `Formato comprimido procesado correctamente con ${decompressionResult.algorithm}`,
                life: 5000
            });

        } catch (error) {
            console.error('‚ùå Error en prueba de descompresi√≥n:', error);

            // Informaci√≥n de diagn√≥stico detallada
            const bufferCompleto = this.respuestaComprimidaSimulada.data[0];
            const diagnostico = this.subcategoriasService['compressionService'].diagnoseData(bufferCompleto);

            console.log('üîç Informaci√≥n de diagn√≥stico completa:');
            console.log('- Formato:', diagnostico.formato);
            console.log('- Longitud del array:', diagnostico.length);
            console.log('- Primeros 10 bytes:', diagnostico.firstBytes);
            console.log('- Algoritmos detectados:', diagnostico.algoritmosDetectados);
            console.log('- ¬øParece comprimido?:', diagnostico.isLikelyCompressed);
            console.log('- ¬øParece texto plano?:', diagnostico.pareceTextoPlano);
            console.log('- Vista hexadecimal:', diagnostico.hexPreview);
            console.log('- Vista como texto:', diagnostico.textPreview.substring(0, 100) + '...');

            // Mostrar informaci√≥n en la UI
            this.respuestaProcesada = `=== DIAGN√ìSTICO DETALLADO ===\n\n` +
                `Formato: ${diagnostico.formato}\n` +
                `Longitud: ${diagnostico.length} bytes\n` +
                `¬øComprimido?: ${diagnostico.isLikelyCompressed ? 'S√ç' : 'NO'}\n` +
                `¬øTexto plano?: ${diagnostico.pareceTextoPlano ? 'S√ç' : 'NO'}\n\n` +
                `Algoritmos detectados:\n` +
                `- GZIP: ${diagnostico.algoritmosDetectados.gzip ? '‚úÖ' : '‚ùå'}\n` +
                `- ZLIB: ${diagnostico.algoritmosDetectados.zlib ? '‚úÖ' : '‚ùå'}\n` +
                `- DEFLATE: ${diagnostico.algoritmosDetectados.deflate ? '‚úÖ' : '‚ùå'}\n\n` +
                `Primeros bytes: [${diagnostico.firstBytes.join(', ')}]\n\n` +
                `Vista hexadecimal: ${diagnostico.hexPreview}\n\n` +
                `Vista como texto:\n${diagnostico.textPreview}\n\n` +
                `=== FIN DEL DIAGN√ìSTICO ===`;

            this.messageService.add({
                severity: 'warn',
                summary: 'An√°lisis Completado',
                detail: `Se realiz√≥ diagn√≥stico del array. Revisa la consola y el √°rea de respuesta procesada.`,
                life: 8000
            });
        }
    }

    /**
     * Probar diferentes escenarios de compresi√≥n
     */
    probarDiferentesEscenarios(): void {
        console.log('üß™ Probando diferentes escenarios de compresi√≥n...');

        const bufferCompleto = this.respuestaComprimidaSimulada.data[0];
        const arrayBytes = this.respuestaComprimidaSimulada.data[0].data.data;
        const escenarios = [
            {
                nombre: 'Buffer Completo',
                data: bufferCompleto,
                descripcion: 'Objeto Buffer completo del usuario'
            },
            {
                nombre: 'Array de Bytes',
                data: arrayBytes,
                descripcion: 'Array de bytes extra√≠do del Buffer'
            },
            {
                nombre: 'Como Uint8Array',
                data: new Uint8Array(arrayBytes),
                descripcion: 'Convertido a Uint8Array'
            }
        ];

        escenarios.forEach((escenario, index) => {
            setTimeout(() => {
                console.log(`\nüéØ Probando escenario ${index + 1}: ${escenario.nombre}`);
                console.log(`üìù Descripci√≥n: ${escenario.descripcion}`);

                try {
                    const resultado = this.subcategoriasService['compressionService'].detectAndDecompress(escenario.data);
                    console.log(`‚úÖ √âxito en escenario ${escenario.nombre}:`, resultado);
                } catch (error) {
                    console.error(`‚ùå Error en escenario ${escenario.nombre}:`, error);

                    // Mostrar diagn√≥stico para cualquier formato
                    const diag = this.subcategoriasService['compressionService'].diagnoseData(escenario.data);
                    console.log(`üîç Diagn√≥stico ${escenario.nombre}:`, diag);
                }
            }, index * 100); // Peque√±o delay entre pruebas
        });

        this.messageService.add({
            severity: 'info',
            summary: 'Pruebas M√∫ltiples',
            detail: 'Se est√°n ejecutando pruebas con diferentes escenarios. Revisa la consola.',
            life: 5000
        });
    }

    /**
     * Limpiar todas las respuestas y m√©tricas
     */
    limpiarRespuestas(): void {
        this.respuestaCruda = '';
        this.respuestaProcesada = '';
        this.algoritmoDetectado = '';
        this.metricasCompresion = null;

        this.messageService.add({
            severity: 'info',
            summary: 'Respuestas Limpias',
            detail: 'Todas las respuestas y m√©tricas han sido limpiadas',
            life: 3000
        });
    }

    // ========== INICIALIZACI√ìN ==========

    initializeServices(): void {
        console.log('üîß Inicializando servicios...');
        this.loadingInit = true;

        // Inicializar servicio de categor√≠as
        this.categoriasService.initialize().subscribe({
            next: () => {
                console.log('‚úÖ Servicio de categor√≠as inicializado');

                // Inicializar servicio de subcategor√≠as
                this.subcategoriasService.initialize().subscribe({
                    next: () => {
                        console.log('‚úÖ Servicio de subcategor√≠as inicializado');
                        this.loadingInit = false;

                        this.messageService.add({
                            severity: 'success',
                            summary: 'Servicios Inicializados',
                            detail: 'Categor√≠as y subcategor√≠as listos para usar',
                            life: 3000
                        });

                        // Cargar categor√≠as autom√°ticamente
                        this.cargarCategorias();
                    },
                    error: (error) => {
                        console.error('‚ùå Error inicializando subcategor√≠as:', error);
                        this.loadingInit = false;
                    }
                });
            },
            error: (error) => {
                console.error('‚ùå Error inicializando categor√≠as:', error);
                this.loadingInit = false;
            }
        });
    }

    // ========== CATEGOR√çAS ==========

    cargarCategorias(): void {
        console.log('üìÇ Cargando categor√≠as...');
        this.loadingCategorias = true;

        this.categoriasService.getCategorias().subscribe({
            next: (categorias) => {
                this.categorias = categorias;
                this.categoriasFiltradas = [...categorias]; // Inicializar lista filtrada
                this.loadingCategorias = false;

                console.log('‚úÖ Categor√≠as cargadas:', categorias);
                console.log('üìä Primera categor√≠a (debug):', categorias[0]);
                console.log('üîç Propiedades de primera categor√≠a:', Object.keys(categorias[0] || {}));
                console.log('üìù Nombre de primera categor√≠a:', categorias[0]?.nombre);

                this.messageService.add({
                    severity: 'success',
                    summary: 'Categor√≠as Cargadas',
                    detail: `Se encontraron ${categorias.length} categor√≠as`,
                    life: 3000
                });
            },
            error: (error) => {
                this.loadingCategorias = false;
                console.error('‚ùå Error cargando categor√≠as:', error);
                // El error ya se maneja en el servicio
            }
        });
    }

    // ========== M√âTODOS PARA AUTOCOMPLETE ==========

    filtrarCategorias(event: any): void {
        const query = event.query.toLowerCase();
        this.categoriasFiltradas = this.categorias.filter(cat =>
            cat.nombre.toLowerCase().includes(query)
        );
    }

    onCategoriaSelect(event: any): void {
        console.log(`üè∑Ô∏è Categor√≠a seleccionada:`, event);
        console.log(`üìù Categor√≠a seleccionada (objeto):`, this.categoriaSeleccionada);
        console.log(`üìù Nombre de categor√≠a seleccionada:`, this.categoriaSeleccionada?.nombre);
        this.subcategoriaSeleccionada = null; // Reset subcategor√≠a
        this.cargarTodasSubcategorias(); // Cargar subcategor√≠as autom√°ticamente
    }

    onCategoriaModelChange(categoria: Categoria | null): void {
        console.log(`üîÑ Modelo de categor√≠a cambi√≥:`, categoria);
        console.log(`üìù Nombre de categor√≠a en modelo:`, categoria?.nombre);
        console.log(`üÜî ID de categor√≠a en modelo:`, categoria?.idcat);
    }

    onCategoriaDropdownShow(): void {
        console.log('üìã Dropdown de categor√≠as abierto');
        // Asegurar que la lista filtrada est√© actualizada
        this.categoriasFiltradas = [...this.categorias];
    }

    onCategoriaClear(): void {
        console.log('üóëÔ∏è Categor√≠a limpiada');
        this.categoriaSeleccionada = null;
        this.subcategoriaSeleccionada = null;
        this.subcategorias = [];
        this.subcategoriasFiltradas = [];
    }

    // ========== SUBCATEGOR√çAS ==========

    cargarTodasSubcategorias(): void {
        if (!this.categoriaSeleccionada) {
            this.messageService.add({
                severity: 'warn',
                summary: 'Seleccione Categor√≠a',
                detail: 'Debe seleccionar una categor√≠a primero',
                life: 3000
            });
            return;
        }

        console.log(`üìã Cargando todas las subcategor√≠as de categor√≠a ${this.categoriaSeleccionada.idcat}...`);
        this.loadingSubcategorias = true;

        this.subcategoriasService.getSubcategorias(this.categoriaSeleccionada.idcat).subscribe({
            next: (subcategorias) => {
                this.subcategorias = subcategorias;
                this.subcategoriasFiltradas = [...subcategorias]; // Inicializar lista filtrada
                this.loadingSubcategorias = false;
                console.log('‚úÖ Subcategor√≠as cargadas:', subcategorias);

                this.actualizarEstadoCache();

                const source = this.subcategoriasService.isCacheLoaded() ? 'CACHE' : 'SERVIDOR';
                this.messageService.add({
                    severity: 'success',
                    summary: 'Subcategor√≠as Cargadas',
                    detail: `${subcategorias.length} subcategor√≠as desde ${source}`,
                    life: 3000
                });
            },
            error: (error) => {
                this.loadingSubcategorias = false;
                console.error('‚ùå Error cargando subcategor√≠as:', error);
                // El error ya se maneja en el servicio
            }
        });
    }

    cargarSubcategoriaEspecifica(): void {
        if (!this.categoriaSeleccionada || !this.subcategoriaSeleccionada) {
            this.messageService.add({
                severity: 'warn',
                summary: 'Selecciones Requeridas',
                detail: 'Debe seleccionar categor√≠a y subcategor√≠a',
                life: 3000
            });
            return;
        }

        console.log(`üéØ Cargando subcategor√≠a espec√≠fica: ${this.subcategoriaSeleccionada.idscat} de categor√≠a ${this.categoriaSeleccionada.idcat}...`);
        this.loadingSubcategorias = true;

        this.subcategoriasService.getSubcategorias(this.categoriaSeleccionada.idcat, this.subcategoriaSeleccionada.idscat).subscribe({
            next: (subcategorias) => {
                this.subcategorias = subcategorias;
                this.loadingSubcategorias = false;
                console.log('‚úÖ Subcategor√≠a espec√≠fica cargada:', subcategorias);

                this.actualizarEstadoCache();

                const source = this.subcategoriasService.isCacheLoaded() ? 'CACHE' : 'SERVIDOR';
                this.messageService.add({
                    severity: 'info',
                    summary: 'Subcategor√≠a Espec√≠fica',
                    detail: `${subcategorias.length} resultado(s) desde ${source}`,
                    life: 3000
                });
            },
            error: (error) => {
                this.loadingSubcategorias = false;
                console.error('‚ùå Error cargando subcategor√≠a espec√≠fica:', error);
                // El error ya se maneja en el servicio
            }
        });
    }

    cargarCatalogoCompleto(): void {
        const params: { swcomp?: 0 | 1 } = this.usarCompresion ? { swcomp: 1 } : { swcomp: 0 };
        const modo = this.usarCompresion ? 'COMPRIMIDO' : 'NORMAL';

        console.log(`üì• Cargando cat√°logo completo de subcategor√≠as (LSCAT - ${modo})...`);
        this.loadingInit = true;

        this.subcategoriasService.loadAllSubcategorias(params).subscribe({
            next: (subcategorias) => {
                console.log('‚úÖ Cat√°logo completo cargado:', subcategorias.length, 'subcategor√≠as');
                this.loadingInit = false;

                // Mostrar respuesta procesada
                this.respuestaProcesada = JSON.stringify(subcategorias, null, 2);

                // Actualizar m√©tricas de compresi√≥n si estaban comprimidos
                if (this.metricasCompresion) {
                    this.metricasCompresion.tamanoDescomprimido = this.respuestaProcesada.length;
                    this.metricasCompresion.ratio = parseFloat(this.calcularRatioCompresion());
                }

                this.actualizarEstadoCache();

                this.messageService.add({
                    severity: 'success',
                    summary: `Cat√°logo ${modo} Cargado`,
                    detail: `${subcategorias.length} subcategor√≠as guardadas en cache`,
                    life: 4000
                });

                // Mostrar un resumen de categor√≠as disponibles
                const categoriasUnicas = [...new Set(subcategorias.map(s => s.idcat))];
                console.log('üìä Categor√≠as disponibles en cache:', categoriasUnicas);
            },
            error: (error) => {
                this.loadingInit = false;
                console.error('‚ùå Error cargando cat√°logo completo:', error);
                // El error ya se maneja en el servicio
            }
        });
    }

    // ========== M√âTODOS PARA AUTOCOMPLETE SUBCATEGOR√çAS ==========

    filtrarSubcategorias(event: any): void {
        const query = event.query.toLowerCase();
        this.subcategoriasFiltradas = this.subcategorias.filter(sub =>
            sub.nombre.toLowerCase().includes(query)
        );
    }

    onSubcategoriaSelect(event: any): void {
        console.log(`üè∑Ô∏è Subcategor√≠a seleccionada:`, event);
    }

    onSubcategoriaClear(): void {
        console.log('üóëÔ∏è Subcategor√≠a limpiada');
        this.subcategoriaSeleccionada = null;
    }

    onSubcategoriaDropdownShow(): void {
        console.log('üìã Dropdown de subcategor√≠as abierto');
        // Asegurar que la lista filtrada est√© actualizada
        this.subcategoriasFiltradas = [...this.subcategorias];
    }

    // ========== UTILIDADES ==========

    clearCache(): void {
        console.log('üóëÔ∏è Limpiando cache de subcategor√≠as...');
        this.subcategoriasService.clearCache();
        this.subcategorias = [];
        this.subcategoriaSeleccionada = null;
        this.actualizarEstadoCache();

        this.messageService.add({
            severity: 'info',
            summary: 'Cache Limpiado',
            detail: 'El cat√°logo de subcategor√≠as ha sido limpiado',
            life: 3000
        });
    }

    // ========== ART√çCULOS ==========

    loadAllArticulos(): void {
        console.log('üì¶ Cargando cat√°logo completo de art√≠culos...');
        this.loadingArticulos = true;

        this.articulosService.loadAllArticulos().subscribe({
            next: (articulos) => {
                this.loadingArticulos = false;
                this.actualizarEstadoCache();

                const source = 'SERVIDOR';
                this.messageService.add({
                    severity: 'success',
                    summary: 'Cat√°logo Cargado',
                    detail: `${articulos.length} art√≠culos cargados en cache desde ${source}`,
                    life: 3000
                });
            },
            error: (error) => {
                this.loadingArticulos = false;
                console.error('‚ùå Error cargando cat√°logo de art√≠culos:', error);
            }
        });
    }

    clearArticulosCache(): void {
        console.log('üóëÔ∏è Limpiando cache de art√≠culos...');
        this.articulosService.clearCache();
        this.actualizarEstadoCache();

        this.messageService.add({
            severity: 'info',
            summary: 'Cache de Art√≠culos Limpiado',
            detail: 'El cat√°logo de art√≠culos ha sido limpiado',
            life: 3000
        });
    }

    // ========== AUTOCOMPLETE ART√çCULOS ==========

    filtrarArticulos(event: any): void {
        const query = event.query.toLowerCase();
        if (!query) {
            this.articulosFiltrados = [...this.articulos];
            return;
        }

        this.articulosFiltrados = this.articulos.filter(art =>
            art.nombre.toLowerCase().includes(query) ||
            art.marca.toLowerCase().includes(query) ||
            art.articulo.toString().includes(query)
        );

        console.log(`üîç Filtrando art√≠culos: "${query}" ‚Üí ${this.articulosFiltrados.length} resultados`);
    }

    onArticuloSelect(event: any): void {
        console.log('üéØ Art√≠culo seleccionado:', event);
        this.articuloSeleccionado = event;
    }

    onArticuloClear(): void {
        console.log('üßπ Art√≠culo limpiado');
        this.articuloSeleccionado = null;
        this.articulosFiltrados = [];
    }

    cargarArticuloEspecifico(): void {
        if (!this.articuloSeleccionado) return;

        console.log('üéØ Cargando art√≠culo espec√≠fico:', this.articuloSeleccionado.articulo);
        this.loadingArticulos = true;

        this.articulosService.getArticulos({
            action: 'GET',
            id: this.articuloSeleccionado.articulo
        }).subscribe({
            next: (articulos) => {
                this.loadingArticulos = false;
                const articulo = articulos.find(a => a.articulo === this.articuloSeleccionado?.articulo);

                if (articulo) {
                    this.articulos = [articulo]; // Mostrar solo el art√≠culo espec√≠fico
                    this.messageService.add({
                        severity: 'success',
                        summary: 'Art√≠culo Cargado',
                        detail: `${articulo.nombre} (${articulo.articulo})`,
                        life: 3000
                    });
                }
            },
            error: (error) => {
                this.loadingArticulos = false;
                console.error('‚ùå Error cargando art√≠culo espec√≠fico:', error);
                this.messageService.add({
                    severity: 'error',
                    summary: 'Error',
                    detail: 'No se pudo cargar el art√≠culo',
                    life: 3000
                });
            }
        });
    }

    // ========== COMPRESI√ìN ART√çCULOS ==========

    onCompresionArticulosChange(event: any): void {
        this.usarCompresionArticulos = event.checked;
        console.log('üîß Compresi√≥n Art√≠culos:', this.usarCompresionArticulos ? 'ACTIVADA' : 'DESACTIVADA');
    }

    mostrarRespuestaCrudaArticulos(respuesta: any): void {
        this.respuestaCrudaArticulos = JSON.stringify(respuesta, null, 2);

        if (respuesta.swcomp === 1) {
            this.algoritmoDetectadoArticulos = 'GZIP (DETECTADO)';

            const tamanoCrudo = this.respuestaCrudaArticulos.length;
            this.metricasCompresionArticulos = {
                algoritmo: 'GZIP',
                ratio: 0,
                tiempoProcesamiento: 0,
                tamanoOriginal: tamanoCrudo,
                tamanoDescomprimido: 0
            };
        } else {
            this.algoritmoDetectadoArticulos = 'SIN COMPRESI√ìN';
            this.metricasCompresionArticulos = null;
        }
    }

    cargarCatalogoCompletoArticulos(): void {
        console.log('üì¶ Cargando cat√°logo completo de art√≠culos con compresi√≥n...');
        this.loadingArticulos = true;

        // Configurar callback para capturar respuesta cruda
        this.articulosService.setRespuestaCrudaCallback((respuesta) => {
            this.mostrarRespuestaCrudaArticulos(respuesta);
        });

        const params: { swcomp?: 0 | 1 } = this.usarCompresionArticulos ? { swcomp: 1 as const } : { swcomp: 0 as const };

        this.articulosService.loadAllArticulos(params).subscribe({
            next: (articulos) => {
                this.loadingArticulos = false;
                this.actualizarEstadoCache();

                const source = this.usarCompresionArticulos ? 'SERVIDOR (COMPRIMIDO)' : 'SERVIDOR';
                this.respuestaProcesadaArticulos = JSON.stringify(articulos, null, 2);

                // Actualizar m√©tricas si hay compresi√≥n
                if (this.metricasCompresionArticulos) {
                    this.metricasCompresionArticulos.tamanoDescomprimido = this.respuestaProcesadaArticulos.length;
                    this.metricasCompresionArticulos.ratio = this.calcularRatioCompresionArticulos();
                }

                this.messageService.add({
                    severity: 'success',
                    summary: 'Cat√°logo Cargado',
                    detail: `${articulos.length} art√≠culos cargados desde ${source}`,
                    life: 3000
                });
            },
            error: (error) => {
                this.loadingArticulos = false;
                console.error('‚ùå Error cargando cat√°logo de art√≠culos:', error);
                this.messageService.add({
                    severity: 'error',
                    summary: 'Error',
                    detail: 'No se pudo cargar el cat√°logo de art√≠culos',
                    life: 3000
                });
            }
        });
    }

    calcularRatioCompresionArticulos(): number {
        if (!this.respuestaCrudaArticulos || !this.respuestaProcesadaArticulos) return 0;
        const ratio = ((this.respuestaCrudaArticulos.length - this.respuestaProcesadaArticulos.length) / this.respuestaCrudaArticulos.length * 100);
        return Math.round(ratio * 100) / 100;
    }

    limpiarRespuestasArticulos(): void {
        this.respuestaCrudaArticulos = '';
        this.respuestaProcesadaArticulos = '';
        this.algoritmoDetectadoArticulos = '';
        this.metricasCompresionArticulos = null;
        console.log('üßπ Respuestas de art√≠culos limpiadas');
    }

    actualizarEstadoCache(): void {
        this.subcategoriasCacheStatus = this.subcategoriasService.getCacheStatus();
        this.articulosCacheStatus = this.articulosService.getCacheStatus();
        console.log('üìä Estado del cache actualizado:', {
            subcategorias: this.subcategoriasCacheStatus,
            articulos: this.articulosCacheStatus
        });
    }

    // ========== NAVEGACI√ìN ==========

    cambiarSeccion(seccion: 'categorias' | 'articulos'): void {
        this.seccionActiva = seccion;
        console.log(`üîÑ Secci√≥n cambiada a: ${seccion}`);
    }

    getCategoriaNombre(idcat: number): string {
        const categoria = this.categorias.find(c => c.idcat === idcat);
        return categoria ? categoria.nombre : 'Desconocida';
    }

    getSubcategoriaNombre(idscat: number): string {
        const subcategoria = this.subcategorias.find(s => s.idscat === idscat);
        return subcategoria ? subcategoria.nombre : 'Desconocida';
    }

    // ========== DEBUG ==========

    /**
     * M√©todo de debug para verificar configuraci√≥n de URLs
     */
    debugUrls(): void {
        console.log('üîß === DEBUG DE URLs ===');

        // Debug del ApiConfigService
        console.log('üìä Informaci√≥n del ApiConfigService:');
        console.log('- Base URL:', this.categoriasService.getBaseUrl());
        console.log('- Cache de subcategor√≠as cargado:', this.subcategoriasService.isCacheLoaded());

        // Debug de URLs espec√≠ficas
        console.log('üéØ URLs espec√≠ficas de servicios:');
        console.log('- Categor√≠as URL:', this.getDebugUrl('categorias'));
        console.log('- Subcategor√≠as URL:', this.getDebugUrl('subcategorias'));

        // Informaci√≥n adicional
        console.log('üìã Estado de servicios:');
        console.log('- Categor√≠as inicializado:', !!this.categoriasService);
        console.log('- Subcategor√≠as inicializado:', !!this.subcategoriasService);

        this.messageService.add({
            severity: 'info',
            summary: 'Debug URLs',
            detail: 'Informaci√≥n de URLs impresa en consola (F12)',
            life: 3000
        });
    }

    /**
     * M√©todo auxiliar para obtener URLs de debug
     */
    private getDebugUrl(service: string): string {
        try {
            switch (service) {
                case 'categorias':
                    // Intentamos obtener el endpoint sin hacer la petici√≥n real
                    const endpoint = (this.categoriasService as any).apiConfigService?.getEndpointById?.(12);
                    return endpoint ? endpoint.url : 'No disponible';
                case 'subcategorias':
                    const subEndpoint = (this.subcategoriasService as any).apiConfigService?.getEndpointById?.(12);
                    return subEndpoint ? subEndpoint.url : 'No disponible';
                default:
                    return 'Servicio desconocido';
            }
        } catch (error) {
            return 'Error obteniendo URL';
        }
    }
}
